<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Billi ‚òÅÔ∏è - Cloud Sync</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lucide-static/0.263.1/lucide.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .category-card {
            transition: all 0.3s ease;
        }

        .category-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .category-card:active {
            cursor: grabbing !important;
        }

        .service-item {
            transition: all 0.2s ease;
        }

        .service-item:hover {
            background: rgba(102, 126, 234, 0.05);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Initialize Supabase
        const supabase = window.supabase.createClient(
            'https://hgemzhdmqvpbztwglwgn.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhnZW16aGRtcXZwYnp0d2dsd2duIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyNzM4MTgsImV4cCI6MjA3Njg0OTgxOH0.zOj9sK9AG1W1Kwg7Z9bPM5IZI73MKmj96OQAwjHhSbo'
        );


        function BilliApp() {
            const [services, setServices] = useState([]);
            const [vehicles, setVehicles] = useState([]);
            const [categories, setCategories] = useState([
                { id: 'internet', name: 'Internet & TV', icon: 'üì°', color: 'bg-blue-500' },
                { id: 'utilities', name: 'Utilities', icon: '‚ö°', color: 'bg-yellow-500' },
                { id: 'subscriptions', name: 'Subscriptions', icon: 'üì∫', color: 'bg-purple-500' },
                { id: 'insurance', name: 'Insurance', icon: 'üõ°Ô∏è', color: 'bg-green-500' },
                { id: 'financial', name: 'Financial', icon: 'üí≥', color: 'bg-indigo-500' },
                { id: 'home', name: 'Home Services', icon: 'üè†', color: 'bg-pink-500' },
                { id: 'vehicles', name: 'Vehicles', icon: 'üöó', color: 'bg-red-500' },
                { id: 'memberships', name: 'Memberships', icon: 'üéØ', color: 'bg-teal-500' },
                { id: 'custom', name: 'Custom', icon: '‚ú®', color: 'bg-orange-500' },
            ]);
            const [showAddModal, setShowAddModal] = useState(false);
            const [showAddVehicleModal, setShowAddVehicleModal] = useState(false);
            const [showEditModal, setShowEditModal] = useState(false);
            const [showCategoryModal, setShowCategoryModal] = useState(false);
            const [showCategoryPickerModal, setShowCategoryPickerModal] = useState(false);
            const [showCreateCustomCategoryModal, setShowCreateCustomCategoryModal] = useState(false);
            const [showEditCategoryModal, setShowEditCategoryModal] = useState(false);
            const [editingCategoryData, setEditingCategoryData] = useState(null);
            const [showServiceDetailModal, setShowServiceDetailModal] = useState(false);
            const [selectedCategory, setSelectedCategory] = useState(null);
            const [preSelectedCategory, setPreSelectedCategory] = useState(null);
            const [preSelectedVehicle, setPreSelectedVehicle] = useState(null);
            const [viewMode, setViewMode] = useState('dashboard'); // dashboard, category, detail
            const [selectedService, setSelectedService] = useState(null);
            const [selectedVehicle, setSelectedVehicle] = useState(null);
            const [showVehicleModal, setShowVehicleModal] = useState(false);
            const [categoryOrder, setCategoryOrder] = useState([
                'internet', 'utilities', 'subscriptions', 'insurance', 
                'financial', 'home', 'vehicles', 'memberships', 'custom'
            ]);
            const [draggedIndex, setDraggedIndex] = useState(null);
            const [customCategoryName, setCustomCategoryName] = useState('Custom');
            const [customCategoryIcon, setCustomCategoryIcon] = useState('‚ú®');
            const [categoryCustomizations, setCategoryCustomizations] = useState({});
            const [editingCategoryName, setEditingCategoryName] = useState(false);
            const [hiddenCategories, setHiddenCategories] = useState([]);
            const [editCategoriesMode, setEditCategoriesMode] = useState(false);
            const [showNotificationSettings, setShowNotificationSettings] = useState(false);
            const [notificationPreferences, setNotificationPreferences] = useState({
                enabled: false,
                daysBeforeRenewal: 7,
                emailNotifications: false
            });
            const [upcomingRenewals, setUpcomingRenewals] = useState([]);
            const [bulkDeleteMode, setBulkDeleteMode] = useState(false);
            const [selectedServices, setSelectedServices] = useState([]);
            const [draggedServiceIndex, setDraggedServiceIndex] = useState(null);
            const [serviceOrder, setServiceOrder] = useState([]);
            
            // Editable text state
            const [appTexts, setAppTexts] = useState({
                appName: 'Billi',
                tagline: 'Your Personal Financial Command Centre',
                welcomeHeading: 'Track Everything',
                welcomeSubtext: 'Manage subscriptions, utilities, insurance, and all your recurring services in one place',
                cloudHeading: 'Cloud Sync',
                cloudSubtext: 'Access your data anywhere, anytime. Automatic cloud backup keeps everything safe',
                totalsHeading: 'Smart Totals',
                totalsSubtext: 'See weekly, monthly, and yearly costs at a glance. Pause services to exclude from totals'
            });
            const [editingText, setEditingText] = useState(null);
            
            // Bank statement import
            const [showImportModal, setShowImportModal] = useState(false);
            const [detectedSubscriptions, setDetectedSubscriptions] = useState([]);
            const [selectedImports, setSelectedImports] = useState([]);

            // Authentication state
            const [user, setUser] = useState(null);
            const [authChecking, setAuthChecking] = useState(true);
            const [showAuthModal, setShowAuthModal] = useState(false);

            // Check if user is logged in on mount
            useEffect(() => {
                supabase.auth.getSession().then(({ data: { session } }) => {
                    setUser(session?.user ?? null);
                    setAuthChecking(false);
                });

                const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
                    setUser(session?.user ?? null);
                });

                return () => subscription.unsubscribe();
            }, []);

            // Load data - from cloud if logged in, localStorage if not
            useEffect(() => {
                if (authChecking) return; // Wait for auth check to complete
                
                if (user) {
                    // Load from cloud
                    loadFromCloud();
                } else {
                    // Load from localStorage
                    const saved = localStorage.getItem('billi-services');
                    const savedVehicles = localStorage.getItem('billi-vehicles');
                    const savedOrder = localStorage.getItem('billi-category-order');
                    
                    if (savedOrder) {
                        setCategoryOrder(JSON.parse(savedOrder));
                    }
                    
                    if (savedVehicles) {
                        setVehicles(JSON.parse(savedVehicles));
                    }
                    
                    if (saved) {
                        setServices(JSON.parse(saved));
                    } else {
                        setServices([
                            {
                                id: 2,
                                category: 'subscriptions',
                                provider: 'Netflix',
                                cost: 15.49,
                                billingCycle: 'monthly',
                                startDate: '2023-06-01',
                                renewalDate: '2024-12-01',
                                username: 'user@email.com',
                                password: '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢',
                                notes: 'Premium plan'
                            }
                        ]);
                    }
                }
            }, [user, authChecking]);

            const loadFromCloud = async () => {
                try {
                    // Load services
                    const { data, error } = await supabase
                        .from('services')
                        .select('*')
                        .eq('user_id', user.id);
                    
                    if (error) throw error;
                    
                    const cloudServices = data.map(s => ({
                        id: s.id,
                        category: s.category,
                        provider: s.provider,
                        cost: parseFloat(s.cost),
                        billingCycle: s.billing_cycle,
                        startDate: s.start_date || '',
                        renewalDate: s.renewal_date || '',
                        accountNumber: s.account_number || '',
                        username: s.username || '',
                        password: s.password || '',
                        phone: s.phone || '',
                        notes: s.notes || '',
                        vehicleId: s.vehicle_id || null,
                        vehicleMake: s.vehicle_make || '',
                        vehicleModel: s.vehicle_model || '',
                        vehicleBodyType: s.vehicle_body_type || '',
                        vehicleYear: s.vehicle_year || '',
                        isPaused: s.is_paused || false
                    }));
                    
                    setServices(cloudServices);
                    
                    // Load vehicles
                    const { data: vehiclesData, error: vehiclesError } = await supabase
                        .from('vehicles')
                        .select('*')
                        .eq('user_id', user.id);
                    
                    if (vehiclesError) {
                        console.error('Error loading vehicles:', vehiclesError);
                    } else {
                        const cloudVehicles = vehiclesData.map(v => ({
                            id: v.id,
                            make: v.make,
                            model: v.model,
                            year: v.year,
                            bodyType: v.body_type,
                            createdAt: v.created_at
                        }));
                        setVehicles(cloudVehicles);
                    }
                } catch (error) {
                    console.error('Error loading from cloud:', error);
                }
            };

            // Save to localStorage
            useEffect(() => {
                if (services.length > 0) {
                    localStorage.setItem('billi-services', JSON.stringify(services));
                }
            }, [services]);

            // Save vehicles to localStorage
            useEffect(() => {
                localStorage.setItem('billi-vehicles', JSON.stringify(vehicles));
            }, [vehicles]);

            // Save category order to localStorage
            useEffect(() => {
                localStorage.setItem('billi-category-order', JSON.stringify(categoryOrder));
            }, [categoryOrder]);

            // Save service order to localStorage
            useEffect(() => {
                if (serviceOrder.length > 0) {
                    localStorage.setItem('billi-service-order', JSON.stringify(serviceOrder));
                }
            }, [serviceOrder]);

            // Load service order
            useEffect(() => {
                const savedServiceOrder = localStorage.getItem('billi-service-order');
                if (savedServiceOrder) {
                    setServiceOrder(JSON.parse(savedServiceOrder));
                }
            }, []);

            // Load and save custom category name
            useEffect(() => {
                const savedName = localStorage.getItem('billi-custom-category-name');
                const savedIcon = localStorage.getItem('billi-custom-category-icon');
                const savedCustomizations = localStorage.getItem('billi-category-customizations');
                const savedHidden = localStorage.getItem('billi-hidden-categories');
                const savedCategories = localStorage.getItem('billi-custom-categories');
                
                if (savedName) setCustomCategoryName(savedName);
                if (savedIcon) setCustomCategoryIcon(savedIcon);
                if (savedCustomizations) setCategoryCustomizations(JSON.parse(savedCustomizations));
                if (savedHidden) setHiddenCategories(JSON.parse(savedHidden));
                
                // Load custom categories and merge with default
                if (savedCategories) {
                    const customCats = JSON.parse(savedCategories);
                    setCategories(prev => {
                        // Filter out any custom categories already in the list
                        const defaults = prev.filter(cat => !cat.id.startsWith('custom_'));
                        return [...defaults, ...customCats];
                    });
                }
            }, []);
            
            // Load and save editable texts
            useEffect(() => {
                const savedTexts = localStorage.getItem('billi-app-texts');
                if (savedTexts) {
                    setAppTexts(JSON.parse(savedTexts));
                }
            }, []);
            
            useEffect(() => {
                localStorage.setItem('billi-app-texts', JSON.stringify(appTexts));
            }, [appTexts]);

            // Save custom categories
            useEffect(() => {
                const customCategories = categories.filter(cat => cat.id.startsWith('custom_'));
                if (customCategories.length > 0) {
                    localStorage.setItem('billi-custom-categories', JSON.stringify(customCategories));
                }
            }, [categories]);

            useEffect(() => {
                localStorage.setItem('billi-custom-category-name', customCategoryName);
            }, [customCategoryName]);

            useEffect(() => {
                localStorage.setItem('billi-custom-category-icon', customCategoryIcon);
            }, [customCategoryIcon]);

            useEffect(() => {
                localStorage.setItem('billi-category-customizations', JSON.stringify(categoryCustomizations));
            }, [categoryCustomizations]);

            useEffect(() => {
                localStorage.setItem('billi-hidden-categories', JSON.stringify(hiddenCategories));
            }, [hiddenCategories]);

            // Load notification preferences
            useEffect(() => {
                const savedPrefs = localStorage.getItem('billi-notification-preferences');
                if (savedPrefs) {
                    setNotificationPreferences(JSON.parse(savedPrefs));
                }
            }, []);

            useEffect(() => {
                localStorage.setItem('billi-notification-preferences', JSON.stringify(notificationPreferences));
            }, [notificationPreferences]);

            // Check for upcoming renewals
            useEffect(() => {
                if (!notificationPreferences.enabled) return;
                
                const checkRenewals = () => {
                    const today = new Date();
                    const upcoming = services.filter(service => {
                        if (!service.renewalDate || service.isPaused) return false;
                        
                        const renewalDate = new Date(service.renewalDate);
                        const daysUntilRenewal = Math.ceil((renewalDate - today) / (1000 * 60 * 60 * 24));
                        
                        return daysUntilRenewal <= notificationPreferences.daysBeforeRenewal && daysUntilRenewal >= 0;
                    });
                    
                    setUpcomingRenewals(upcoming);
                };
                
                checkRenewals();
                const interval = setInterval(checkRenewals, 1000 * 60 * 60); // Check every hour
                
                return () => clearInterval(interval);
            }, [services, notificationPreferences]);

            const addService = async (serviceData) => {
                if (user) {
                    // Save to cloud
                    try {
                        // Prepare data object - only include vehicle_id if it exists
                        const serviceToSave = {
                            user_id: user.id,
                            category: serviceData.category,
                            provider: serviceData.provider || serviceData.name, // Support both provider and name
                            cost: serviceData.cost,
                            billing_cycle: serviceData.billingCycle || serviceData.frequency, // Support both fields
                            start_date: serviceData.startDate,
                            renewal_date: serviceData.renewalDate,
                            account_number: serviceData.accountNumber,
                            username: serviceData.username,
                            password: serviceData.password,
                            phone: serviceData.phone,
                            notes: serviceData.notes,
                            vehicle_make: serviceData.vehicleMake,
                            vehicle_model: serviceData.vehicleModel,
                            vehicle_body_type: serviceData.vehicleBodyType,
                            vehicle_year: serviceData.vehicleYear,
                            is_paused: serviceData.isPaused || false
                        };
                        
                        // Only add vehicle_id if it's provided
                        if (serviceData.vehicleId) {
                            serviceToSave.vehicle_id = serviceData.vehicleId;
                        }
                        
                        const { data, error } = await supabase
                            .from('services')
                            .insert([serviceToSave])
                            .select()
                            .single();
                        
                        if (error) {
                            // If vehicle_id column doesn't exist, try without it
                            if (error.message && error.message.includes('vehicle_id')) {
                                console.warn('Database missing vehicle_id column, saving without it');
                                delete serviceToSave.vehicle_id;
                                const retry = await supabase
                                    .from('services')
                                    .insert([serviceToSave])
                                    .select()
                                    .single();
                                if (retry.error) throw retry.error;
                                const newService = {
                                    id: retry.data.id,
                                    category: retry.data.category,
                                    provider: retry.data.provider,
                                    cost: parseFloat(retry.data.cost),
                                    billingCycle: retry.data.billing_cycle,
                                    startDate: retry.data.start_date || '',
                                    renewalDate: retry.data.renewal_date || '',
                                    accountNumber: retry.data.account_number || '',
                                    username: retry.data.username || '',
                                    password: retry.data.password || '',
                                    phone: retry.data.phone || '',
                                    notes: retry.data.notes || '',
                                    vehicleId: serviceData.vehicleId || null, // Keep in memory even if not in DB
                                    vehicleMake: retry.data.vehicle_make || '',
                                    vehicleModel: retry.data.vehicle_model || '',
                                    vehicleBodyType: retry.data.vehicle_body_type || '',
                                    vehicleYear: retry.data.vehicle_year || '',
                                    isPaused: retry.data.is_paused || false
                                };
                                setServices([...services, newService]);
                                return;
                            }
                            throw error;
                        }
                        
                        const newService = {
                            id: data.id,
                            category: data.category,
                            provider: data.provider,
                            cost: parseFloat(data.cost),
                            billingCycle: data.billing_cycle,
                            startDate: data.start_date || '',
                            renewalDate: data.renewal_date || '',
                            accountNumber: data.account_number || '',
                            username: data.username || '',
                            password: data.password || '',
                            phone: data.phone || '',
                            notes: data.notes || '',
                            vehicleId: data.vehicle_id || null,
                            vehicleMake: data.vehicle_make || '',
                            vehicleModel: data.vehicle_model || '',
                            vehicleBodyType: data.vehicle_body_type || '',
                            vehicleYear: data.vehicle_year || '',
                            isPaused: data.is_paused || false
                        };
                        
                        setServices([...services, newService]);
                    } catch (error) {
                        console.error('Error adding service:', error);
                        alert('Failed to add service: ' + error.message);
                    }
                } else {
                    // Save to localStorage
                    const newService = {
                        ...serviceData,
                        id: Date.now()
                    };
                    setServices([...services, newService]);
                }
                setShowAddModal(false);
                setPreSelectedCategory(null);
            };

            const editService = async (serviceData) => {
                if (user) {
                    // Update in cloud
                    try {
                        const updateData = {
                            category: serviceData.category,
                            provider: serviceData.provider,
                            cost: serviceData.cost,
                            billing_cycle: serviceData.billingCycle,
                            start_date: serviceData.startDate,
                            renewal_date: serviceData.renewalDate,
                            account_number: serviceData.accountNumber,
                            username: serviceData.username,
                            password: serviceData.password,
                            phone: serviceData.phone,
                            notes: serviceData.notes,
                            vehicle_make: serviceData.vehicleMake,
                            vehicle_model: serviceData.vehicleModel,
                            vehicle_body_type: serviceData.vehicleBodyType,
                            vehicle_year: serviceData.vehicleYear,
                            is_paused: serviceData.isPaused || false
                        };
                        
                        // Only add vehicle_id if it exists
                        if (serviceData.vehicleId !== undefined) {
                            updateData.vehicle_id = serviceData.vehicleId;
                        }
                        
                        const { error } = await supabase
                            .from('services')
                            .update(updateData)
                            .eq('id', serviceData.id)
                            .eq('user_id', user.id);
                        
                        if (error) {
                            // If vehicle_id column doesn't exist, try without it
                            if (error.message && (error.message.includes('vehicle_id') || error.message.includes('Failed to fetch'))) {
                                console.warn('Database issue, updating without vehicle_id');
                                delete updateData.vehicle_id;
                                const retry = await supabase
                                    .from('services')
                                    .update(updateData)
                                    .eq('id', serviceData.id)
                                    .eq('user_id', user.id);
                                if (retry.error && !retry.error.message.includes('Failed to fetch')) {
                                    throw retry.error;
                                }
                            } else {
                                throw error;
                            }
                        }
                    } catch (error) {
                        console.error('Error updating service:', error);
                        alert('Failed to update service: ' + error.message);
                        return;
                    }
                }
                
                setServices(services.map(s => s.id === serviceData.id ? serviceData : s));
                setShowEditModal(false);
                setSelectedService(serviceData);
            };

            const deleteService = async (id) => {
                if (user) {
                    // Delete from cloud
                    try {
                        const { error } = await supabase
                            .from('services')
                            .delete()
                            .eq('id', id)
                            .eq('user_id', user.id);
                        
                        if (error) throw error;
                    } catch (error) {
                        console.error('Error deleting service:', error);
                        alert('Failed to delete service: ' + error.message);
                        return;
                    }
                }
                
                setServices(services.filter(s => s.id !== id));
                setSelectedService(null);
                setShowServiceDetailModal(false);
                setShowCategoryModal(false);
                setViewMode('dashboard');
            };

            const getTotalWeeklyCost = () => {
                return services.reduce((total, service) => {
                    if (service.isPaused) return total; // Skip paused services
                    const cycle = service.billingCycle || service.frequency; // Support both fields
                    if (cycle === 'one-time') return total; // Skip one-time
                    const cost = parseFloat(service.cost) || 0;
                    let weeklyCost = 0;
                    if (cycle === 'weekly' || cycle === 'Weekly') {
                        weeklyCost = cost;
                    } else if (cycle === 'fortnightly' || cycle === 'Fortnightly') {
                        weeklyCost = cost / 2;
                    } else if (cycle === 'monthly' || cycle === 'Monthly') {
                        weeklyCost = cost / 4.33;
                    } else if (cycle === 'quarterly' || cycle === 'Quarterly') {
                        weeklyCost = cost / 13;
                    } else if (cycle === 'yearly' || cycle === 'Yearly') {
                        weeklyCost = cost / 52;
                    }
                    return total + weeklyCost;
                }, 0);
            };

            const getTotalMonthlyCost = () => {
                return services.reduce((total, service) => {
                    if (service.isPaused) return total; // Skip paused services
                    const cycle = service.billingCycle || service.frequency; // Support both fields
                    if (cycle === 'one-time') return total; // Skip one-time
                    const cost = parseFloat(service.cost) || 0;
                    let monthlyCost = 0;
                    if (cycle === 'weekly' || cycle === 'Weekly') {
                        monthlyCost = cost * 4.33;
                    } else if (cycle === 'fortnightly' || cycle === 'Fortnightly') {
                        monthlyCost = cost * 2.17;
                    } else if (cycle === 'monthly' || cycle === 'Monthly') {
                        monthlyCost = cost;
                    } else if (cycle === 'quarterly' || cycle === 'Quarterly') {
                        monthlyCost = cost / 3;
                    } else if (cycle === 'yearly' || cycle === 'Yearly') {
                        monthlyCost = cost / 12;
                    }
                    return total + monthlyCost;
                }, 0);
            };

            const getTotalYearlyCost = () => {
                return services.reduce((total, service) => {
                    if (service.isPaused) return total; // Skip paused services
                    const cycle = service.billingCycle || service.frequency; // Support both fields
                    if (cycle === 'one-time') return total; // Skip one-time
                    const cost = parseFloat(service.cost) || 0;
                    let yearlyCost = 0;
                    if (cycle === 'weekly' || cycle === 'Weekly') {
                        yearlyCost = cost * 52;
                    } else if (cycle === 'fortnightly' || cycle === 'Fortnightly') {
                        yearlyCost = cost * 26;
                    } else if (cycle === 'monthly' || cycle === 'Monthly') {
                        yearlyCost = cost * 12;
                    } else if (cycle === 'quarterly' || cycle === 'Quarterly') {
                        yearlyCost = cost * 4;
                    } else if (cycle === 'yearly' || cycle === 'Yearly') {
                        yearlyCost = cost;
                    }
                    return total + yearlyCost;
                }, 0);
            };

            const getOneTimeCost = () => {
                return services.reduce((total, service) => {
                    if (service.billingCycle === 'one-time') {
                        return total + service.cost;
                    }
                    return total;
                }, 0);
            };

            const toggleServiceSelection = (serviceId) => {
                setSelectedServices(prev => 
                    prev.includes(serviceId) 
                        ? prev.filter(id => id !== serviceId)
                        : [...prev, serviceId]
                );
            };

            const bulkDeleteServices = async () => {
                if (selectedServices.length === 0) return;
                
                if (!confirm(`Delete ${selectedServices.length} service${selectedServices.length > 1 ? 's' : ''}?`)) {
                    return;
                }

                if (user) {
                    try {
                        const { error } = await supabase
                            .from('services')
                            .delete()
                            .in('id', selectedServices)
                            .eq('user_id', user.id);
                        
                        if (error) throw error;
                    } catch (error) {
                        console.error('Error deleting services:', error);
                        alert('Failed to delete services: ' + error.message);
                        return;
                    }
                }

                setServices(services.filter(s => !selectedServices.includes(s.id)));
                setSelectedServices([]);
                setBulkDeleteMode(false);
            };

            const handleServiceDragStart = (index) => {
                setDraggedServiceIndex(index);
            };

            const handleServiceDragOver = (e, index) => {
                e.preventDefault();
                e.stopPropagation();
                
                if (draggedServiceIndex === null || draggedServiceIndex === index) return;

                const sortedServices = getSortedServices();
                const newOrder = [...sortedServices];
                const draggedItem = newOrder[draggedServiceIndex];
                
                newOrder.splice(draggedServiceIndex, 1);
                newOrder.splice(index, 0, draggedItem);
                
                // Update service order
                const newServiceOrder = newOrder.map(s => s.id);
                setServiceOrder(newServiceOrder);
                setDraggedServiceIndex(index);
            };

            const handleServiceDragEnd = () => {
                setDraggedServiceIndex(null);
            };

            const getSortedServices = () => {
                // Separate active and paused services
                const activeServices = services.filter(s => !s.isPaused);
                const pausedServices = services.filter(s => s.isPaused);

                // Sort active services by custom order
                let sortedActive = [...activeServices];
                if (serviceOrder.length > 0) {
                    sortedActive = sortedActive.sort((a, b) => {
                        const aIndex = serviceOrder.indexOf(a.id);
                        const bIndex = serviceOrder.indexOf(b.id);
                        if (aIndex === -1 && bIndex === -1) return 0;
                        if (aIndex === -1) return 1;
                        if (bIndex === -1) return -1;
                        return aIndex - bIndex;
                    });
                }

                // Sort paused services by custom order
                let sortedPaused = [...pausedServices];
                if (serviceOrder.length > 0) {
                    sortedPaused = sortedPaused.sort((a, b) => {
                        const aIndex = serviceOrder.indexOf(a.id);
                        const bIndex = serviceOrder.indexOf(b.id);
                        if (aIndex === -1 && bIndex === -1) return 0;
                        if (aIndex === -1) return 1;
                        if (bIndex === -1) return -1;
                        return aIndex - bIndex;
                    });
                }

                // Return active first, then paused
                return [...sortedActive, ...sortedPaused];
            };

            // Vehicle Management Functions
            const addVehicle = async (vehicleData) => {
                const newVehicle = {
                    id: Date.now(),
                    ...vehicleData,
                    createdAt: new Date().toISOString()
                };
                
                if (user) {
                    // Try to save to cloud
                    try {
                        const { data, error } = await supabase
                            .from('vehicles')
                            .insert([{
                                user_id: user.id,
                                make: vehicleData.make,
                                model: vehicleData.model,
                                year: vehicleData.year,
                                body_type: vehicleData.bodyType,
                                created_at: newVehicle.createdAt
                            }])
                            .select()
                            .single();
                        
                        if (error) {
                            // If table doesn't exist, just use localStorage
                            if (error.message && error.message.includes('vehicles')) {
                                console.warn('Vehicles table not found, using localStorage only');
                            } else {
                                throw error;
                            }
                        } else {
                            // Use database ID
                            newVehicle.id = data.id;
                        }
                    } catch (error) {
                        console.error('Error saving vehicle:', error);
                        // Don't show alert, just continue with localStorage
                    }
                }
                
                setVehicles([...vehicles, newVehicle]);
            };

            const deleteVehicle = (vehicleId) => {
                // Remove vehicle
                const updatedVehicles = vehicles.filter(v => v.id !== vehicleId);
                setVehicles(updatedVehicles);
                
                // Unlink services from this vehicle
                const updatedServices = services.map(s => 
                    s.vehicleId === vehicleId ? { ...s, vehicleId: null } : s
                );
                setServices(updatedServices);
            };

            const getVehicleServices = (vehicleId) => {
                return services.filter(s => s.vehicleId === vehicleId);
            };

            const getVehicleMonthlyCost = (vehicleId) => {
                const vehicleServices = getVehicleServices(vehicleId);
                return vehicleServices.reduce((total, service) => {
                    if (service.isPaused || service.billingCycle === 'one-time') return total;
                    
                    let monthlyCost = 0;
                    if (service.billingCycle === 'weekly') {
                        monthlyCost = service.cost * 4.33;
                    } else if (service.billingCycle === 'monthly') {
                        monthlyCost = service.cost;
                    } else if (service.billingCycle === 'yearly') {
                        monthlyCost = service.cost / 12;
                    }
                    return total + monthlyCost;
                }, 0);
            };

            const togglePause = async (serviceId) => {
                const service = services.find(s => s.id === serviceId);
                if (!service) return;

                const updatedService = {
                    ...service,
                    isPaused: !service.isPaused
                };

                if (user) {
                    // Update in cloud
                    try {
                        const { error } = await supabase
                            .from('services')
                            .update({ is_paused: updatedService.isPaused })
                            .eq('id', serviceId)
                            .eq('user_id', user.id);
                        
                        if (error) throw error;
                    } catch (error) {
                        console.error('Error toggling pause:', error);
                        alert('Failed to update service: ' + error.message);
                        return;
                    }
                }

                setServices(services.map(s => s.id === serviceId ? updatedService : s));
                setSelectedService(updatedService);

                // Move service to appropriate section by removing it from custom order
                // This will cause it to appear at the start of its new section
                setServiceOrder(prev => prev.filter(id => id !== serviceId));
            };

            const getServicesByCategory = (categoryId) => {
                return services.filter(s => s.category === categoryId);
            };

            const handleDragStart = (index) => {
                setDraggedIndex(index);
            };

            const handleDragOver = (e, index) => {
                e.preventDefault();
                e.stopPropagation();
                
                if (draggedIndex === null || draggedIndex === index) return;

                // Get the current visible categories
                const visibleCategories = getOrderedCategories();
                
                // Map back to the full order
                const draggedCategoryId = visibleCategories[draggedIndex].id;
                const targetCategoryId = visibleCategories[index].id;
                
                const newOrder = [...categoryOrder];
                const draggedOrderIndex = newOrder.indexOf(draggedCategoryId);
                const targetOrderIndex = newOrder.indexOf(targetCategoryId);
                
                // Remove dragged item and insert at new position
                newOrder.splice(draggedOrderIndex, 1);
                newOrder.splice(targetOrderIndex, 0, draggedCategoryId);
                
                setCategoryOrder(newOrder);
                setDraggedIndex(index);
            };

            const handleDragEnd = () => {
                setDraggedIndex(null);
            };

            const handleCategoryClick = (category, e) => {
                // Only open category if we're not dragging
                if (draggedIndex === null) {
                    setSelectedCategory(category);
                    setShowCategoryModal(true);
                }
            };

            const getOrderedCategories = () => {
                return categoryOrder
                    .map(id => categories.find(cat => cat.id === id))
                    .filter(Boolean)
                    .filter(cat => !hiddenCategories.includes(cat.id));
            };

            const toggleCategoryVisibility = (categoryId) => {
                const hasServices = services.some(s => s.category === categoryId);
                if (hasServices) {
                    alert('Cannot hide category with existing services. Please delete or move services first.');
                    return;
                }
                
                setHiddenCategories(prev => 
                    prev.includes(categoryId)
                        ? prev.filter(id => id !== categoryId)
                        : [...prev, categoryId]
                );
            };

            const getCategoryDisplayName = (category) => {
                if (category.id === 'custom') return customCategoryName;
                return categoryCustomizations[category.id]?.name || category.name;
            };

            const getCategoryDisplayIcon = (category) => {
                if (category.id === 'custom') return customCategoryIcon;
                return categoryCustomizations[category.id]?.icon || category.icon;
            };

            const updateCategoryCustomization = (categoryId, field, value) => {
                setCategoryCustomizations(prev => ({
                    ...prev,
                    [categoryId]: {
                        ...prev[categoryId],
                        [field]: value
                    }
                }));
            };
            
            // Bank Statement Import Functions
            const parseCSVDate = (dateStr) => {
                const [day, month, year] = dateStr.split('/');
                return new Date(year, month - 1, day);
            };
            
            const detectFrequency = (dates) => {
                if (dates.length < 2) return null;
                
                const sortedDates = dates.map(d => parseCSVDate(d)).sort((a, b) => a - b);
                const gaps = [];
                
                for (let i = 1; i < sortedDates.length; i++) {
                    const gap = (sortedDates[i] - sortedDates[i-1]) / (1000 * 60 * 60 * 24);
                    gaps.push(gap);
                }
                
                const avgGap = gaps.reduce((a, b) => a + b, 0) / gaps.length;
                
                if (avgGap >= 6 && avgGap <= 8) return 'Weekly';
                if (avgGap >= 13 && avgGap <= 15) return 'Fortnightly';
                if (avgGap >= 28 && avgGap <= 32) return 'Monthly';
                if (avgGap >= 88 && avgGap <= 95) return 'Quarterly';
                if (avgGap >= 360 && avgGap <= 370) return 'Yearly';
                return `Every ${Math.round(avgGap)} days`;
            };
            
            const handleCSVUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    const lines = text.split('\n');
                    const headers = lines[0].split(',');
                    
                    // Parse transactions
                    const transactions = [];
                    for (let i = 1; i < lines.length; i++) {
                        const values = lines[i].split(',');
                        if (values.length < 4) continue;
                        
                        const transaction = {
                            date: values[1]?.replace(/"/g, ''),
                            narrative: values[2]?.replace(/"/g, ''),
                            debit: values[3]?.replace(/"/g, '')
                        };
                        
                        if (transaction.debit) {
                            transactions.push(transaction);
                        }
                    }
                    
                    // Group by payee and amount
                    const recurring = {};
                    
                    transactions.forEach(trans => {
                        let payee = trans.narrative;
                        
                        // Clean payee name
                        if (payee.includes('DEBIT CARD PURCHASE')) {
                            payee = payee.replace('DEBIT CARD PURCHASE', '').trim().split(' ').slice(0, 3).join(' ');
                        } else if (payee.includes('PAYMENT BY AUTHORITY TO')) {
                            payee = payee.replace('PAYMENT BY AUTHORITY TO', '').trim().split(' ').slice(0, 3).join(' ');
                        } else if (payee.includes('WITHDRAWAL')) {
                            return; // Skip manual transfers
                        } else {
                            payee = payee.substring(0, 40);
                        }
                        
                        const amount = parseFloat(trans.debit);
                        const key = `${payee}_${amount}`;
                        
                        if (!recurring[key]) {
                            recurring[key] = {
                                payee: payee,
                                amount: amount,
                                dates: [],
                                fullNarrative: trans.narrative
                            };
                        }
                        
                        recurring[key].dates.push(trans.date);
                    });
                    
                    // Filter for recurring (2+ occurrences) and detect frequency
                    const detected = Object.values(recurring)
                        .filter(item => item.dates.length >= 2)
                        .map(item => ({
                            ...item,
                            frequency: detectFrequency(item.dates),
                            occurrences: item.dates.length
                        }))
                        .filter(item => item.frequency && !item.frequency.includes('Every'))
                        .sort((a, b) => b.occurrences - a.occurrences);
                    
                    setDetectedSubscriptions(detected);
                    setSelectedImports(detected.map((_, i) => i)); // Select all by default
                };
                
                reader.readAsText(file);
            };
            
            const handleImportSelected = (servicesToAdd) => {
                // Convert imported services to proper format and call addService
                if (Array.isArray(servicesToAdd)) {
                    servicesToAdd.forEach(service => {
                        // Convert to proper service structure
                        const properService = {
                            provider: service.name, // Convert name to provider
                            cost: parseFloat(service.cost),
                            billingCycle: service.frequency, // Convert frequency to billingCycle
                            category: service.category,
                            startDate: '',
                            renewalDate: service.renewalDate || '',
                            accountNumber: service.accountNumber || '',
                            username: service.username || '',
                            password: service.password || '',
                            phone: service.phone || '',
                            notes: service.notes || '',
                            isPaused: false
                        };
                        
                        // Call the existing addService function
                        addService(properService);
                    });
                }
            };
            
            // Editable Text Component
            const EditableText = ({ textKey, className = "", defaultText = "" }) => {
                const isEditing = editingText === textKey;
                const text = appTexts[textKey] || defaultText;
                
                return (
                    <div 
                        className={`relative inline-block ${className}`}
                        onDoubleClick={() => setEditingText(textKey)}
                    >
                        {isEditing ? (
                            <input
                                type="text"
                                value={text}
                                onChange={(e) => setAppTexts(prev => ({ ...prev, [textKey]: e.target.value }))}
                                onBlur={() => setEditingText(null)}
                                onKeyDown={(e) => e.key === 'Enter' && setEditingText(null)}
                                className="border-2 border-blue-500 rounded px-2 py-1 w-full"
                                autoFocus
                            />
                        ) : (
                            <span className="cursor-pointer hover:bg-yellow-100 hover:bg-opacity-50 rounded px-1 transition-all">
                                {text}
                            </span>
                        )}
                    </div>
                );
            };

            return (
                <div className="min-h-screen p-4 md:p-8">
                    {!user ? (
                        // Welcome Screen
                        <div className="max-w-4xl mx-auto">
                            <div className="glass-effect rounded-3xl p-12 shadow-2xl text-center">
                                <div className="mb-8">
                                    <h1 className="text-6xl font-bold text-gray-800 mb-4">
                                        <EditableText textKey="appName" defaultText="Billi" /> ‚òÅÔ∏è
                                    </h1>
                                    <p className="text-2xl text-gray-600 mb-8">
                                        <EditableText textKey="tagline" defaultText="Your Personal Financial Command Centre" />
                                    </p>
                                </div>

                                <div className="grid md:grid-cols-3 gap-6 mb-12">
                                    <div className="p-6 bg-white/50 rounded-2xl">
                                        <div className="text-5xl mb-4">üìä</div>
                                        <h3 className="font-bold text-lg text-gray-800 mb-2">
                                            <EditableText textKey="welcomeHeading" defaultText="Track Everything" />
                                        </h3>
                                        <p className="text-gray-600 text-sm">
                                            <EditableText textKey="welcomeSubtext" defaultText="Manage subscriptions, utilities, insurance, and all your recurring services in one place" />
                                        </p>
                                    </div>
                                    <div className="p-6 bg-white/50 rounded-2xl">
                                        <div className="text-5xl mb-4">‚òÅÔ∏è</div>
                                        <h3 className="font-bold text-lg text-gray-800 mb-2">
                                            <EditableText textKey="cloudHeading" defaultText="Cloud Sync" />
                                        </h3>
                                        <p className="text-gray-600 text-sm">
                                            <EditableText textKey="cloudSubtext" defaultText="Access your data anywhere, anytime. Automatic cloud backup keeps everything safe" />
                                        </p>
                                    </div>
                                    <div className="p-6 bg-white/50 rounded-2xl">
                                        <div className="text-5xl mb-4">üí∞</div>
                                        <h3 className="font-bold text-lg text-gray-800 mb-2">
                                            <EditableText textKey="totalsHeading" defaultText="Smart Totals" />
                                        </h3>
                                        <p className="text-gray-600 text-sm">
                                            <EditableText textKey="totalsSubtext" defaultText="See weekly, monthly, and yearly costs at a glance. Pause services to exclude from totals" />
                                        </p>
                                    </div>
                                </div>

                                <div className="space-y-4">
                                    <button
                                        onClick={() => setShowAuthModal(true)}
                                        className="w-full md:w-auto bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-12 py-4 rounded-xl hover:shadow-lg transition-all font-bold text-lg"
                                    >
                                        Get Started - It's Free
                                    </button>
                                    <p className="text-gray-500 text-sm">
                                        Sign up or sign in to start tracking your services
                                    </p>
                                    <p className="text-gray-400 text-xs mt-4 italic">
                                        üí° Tip: Double-click any text to customise it
                                    </p>
                                </div>
                            </div>
                        </div>
                    ) : (
                    // Main App (existing dashboard)
                    <div className="max-w-7xl mx-auto">
                        {/* Header */}
                        <header className="glass-effect rounded-2xl p-6 mb-8 shadow-xl">
                            <div className="flex justify-between items-center">
                                <div>
                                    <h1 className="text-4xl font-bold text-gray-800 mb-2">
                                        <EditableText textKey="appName" defaultText="Billi" /> ‚òÅÔ∏è
                                    </h1>
                                    <p className="text-gray-600">
                                        <EditableText textKey="tagline" defaultText="Your personal financial command centre" />
                                        {user && <span className="text-green-600 ml-2">‚Ä¢ Signed in as {user.email}</span>}
                                    </p>
                                    <p className="text-gray-400 text-xs mt-1 italic">üí° Double-click text to customise</p>
                                </div>
                                <div className="flex gap-3">
                                    {/* Notification Bell */}
                                    <button
                                        onClick={() => setShowNotificationSettings(true)}
                                        className="relative bg-white text-gray-700 px-4 py-3 rounded-xl hover:bg-gray-100 transition-all font-semibold border-2 border-gray-200"
                                    >
                                        üîî
                                        {upcomingRenewals.length > 0 && (
                                            <span className="absolute -top-1 -right-1 bg-red-600 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">
                                                {upcomingRenewals.length}
                                            </span>
                                        )}
                                    </button>
                                    <button
                                        onClick={() => setShowAddModal(true)}
                                        className="bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-6 py-3 rounded-xl hover:shadow-lg transition-all font-semibold"
                                    >
                                        + Add Service
                                    </button>
                                    <button
                                        onClick={() => setShowImportModal(true)}
                                        className="bg-green-600 text-white px-6 py-3 rounded-xl hover:bg-green-700 transition-all font-semibold"
                                    >
                                        üìä Import CSV
                                    </button>
                                    {user ? (
                                        <button
                                            onClick={async () => {
                                                await supabase.auth.signOut();
                                                setServices([]); // Clear services on sign out
                                                setViewMode('dashboard'); // Reset to dashboard
                                                setSelectedCategory(null);
                                                setSelectedService(null);
                                            }}
                                            className="bg-gray-200 text-gray-700 px-6 py-3 rounded-xl hover:bg-gray-300 transition-all font-semibold"
                                        >
                                            Sign Out
                                        </button>
                                    ) : (
                                        <button
                                            onClick={() => setShowAuthModal(true)}
                                            className="bg-green-600 text-white px-6 py-3 rounded-xl hover:bg-green-700 transition-all font-semibold"
                                        >
                                            Sign In / Sign Up
                                        </button>
                                    )}
                                </div>
                            </div>
                        </header>

                        {/* Cost Summary */}
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8">
                            <div className="glass-effect rounded-2xl p-6 shadow-lg">
                                <div className="text-sm text-gray-600 mb-1">Weekly Total</div>
                                <div className="text-3xl font-bold text-green-600">
                                    ${getTotalWeeklyCost().toFixed(2)}
                                </div>
                            </div>
                            <div className="glass-effect rounded-2xl p-6 shadow-lg">
                                <div className="text-sm text-gray-600 mb-1">Monthly Total</div>
                                <div className="text-3xl font-bold text-indigo-600">
                                    ${getTotalMonthlyCost().toFixed(2)}
                                </div>
                            </div>
                            <div className="glass-effect rounded-2xl p-6 shadow-lg">
                                <div className="text-sm text-gray-600 mb-1">Yearly Total</div>
                                <div className="text-3xl font-bold text-purple-600">
                                    ${getTotalYearlyCost().toFixed(2)}
                                </div>
                            </div>
                            <div className="glass-effect rounded-2xl p-6 shadow-lg">
                                <div className="text-sm text-gray-600 mb-1">Active Services</div>
                                <div className="text-3xl font-bold text-pink-600">
                                    {services.filter(s => !s.isPaused).length}
                                </div>
                            </div>
                        </div>

                        {/* One-Time Purchases */}
                        {getOneTimeCost() > 0 && (
                            <div className="glass-effect rounded-2xl p-6 shadow-lg mb-8">
                                <div className="flex justify-between items-center">
                                    <div>
                                        <div className="text-sm text-gray-600 mb-1">One-Time Purchases</div>
                                        <div className="text-2xl font-bold text-orange-600">
                                            ${getOneTimeCost().toFixed(2)}
                                        </div>
                                    </div>
                                    <div className="text-sm text-gray-500 italic">
                                        Not included in recurring totals
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Categories Grid */}
                        <div className="mb-4 flex justify-between items-center">
                            <h2 className="text-2xl font-bold text-gray-800">Categories</h2>
                            <div className="flex gap-2">
                                <button
                                    onClick={() => setShowCategoryPickerModal(true)}
                                    className="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-all font-semibold text-sm"
                                >
                                    + Add Category
                                </button>
                                <button
                                    onClick={() => setEditCategoriesMode(!editCategoriesMode)}
                                    className={`${
                                        editCategoriesMode 
                                            ? 'bg-green-600 hover:bg-green-700' 
                                            : 'bg-gray-600 hover:bg-gray-700'
                                    } text-white px-4 py-2 rounded-lg transition-all font-semibold text-sm`}
                                >
                                    {editCategoriesMode ? '‚úì Done' : '‚úèÔ∏è Edit Categories'}
                                </button>
                            </div>
                        </div>
                        <div className="grid grid-cols-2 md:grid-cols-3 gap-4 mb-8">
                            {getOrderedCategories().map((category, index) => {
                                const count = getServicesByCategory(category.id).length;
                                const displayName = getCategoryDisplayName(category);
                                const displayIcon = getCategoryDisplayIcon(category);
                                const truncatedName = displayName.length > 20 ? displayName.substring(0, 20) + '...' : displayName;
                                return (
                                    <div
                                        key={category.id}
                                        draggable={!editCategoriesMode}
                                        onDragStart={(e) => {
                                            if (!editCategoriesMode) {
                                                e.stopPropagation();
                                                handleDragStart(index);
                                            } else {
                                                e.preventDefault();
                                            }
                                        }}
                                        onDragEnter={(e) => {
                                            if (!editCategoriesMode) {
                                                e.preventDefault();
                                            }
                                        }}
                                        onDragOver={(e) => {
                                            if (!editCategoriesMode) {
                                                e.preventDefault();
                                                e.stopPropagation();
                                                handleDragOver(e, index);
                                            }
                                        }}
                                        onDragEnd={(e) => {
                                            if (!editCategoriesMode) {
                                                e.stopPropagation();
                                                handleDragEnd();
                                            }
                                        }}
                                        onClick={(e) => !editCategoriesMode && handleCategoryClick(category, e)}
                                        className={`glass-effect rounded-2xl p-6 ${!editCategoriesMode ? 'cursor-move category-card' : ''} shadow-lg relative group transition-all ${
                                            draggedIndex === index ? 'opacity-30 scale-95' : ''
                                        }`}
                                    >
                                        {editCategoriesMode && (
                                            <button
                                                onClick={(e) => {
                                                    e.stopPropagation();
                                                    toggleCategoryVisibility(category.id);
                                                }}
                                                className="absolute top-2 right-2 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-700 text-xs"
                                            >
                                                √ó
                                            </button>
                                        )}
                                        
                                        {/* Icon with hover edit */}
                                        <div className="relative inline-block mb-3" onDragStart={(e) => e.stopPropagation()}>
                                            <div className="text-4xl pointer-events-none">{displayIcon}</div>
                                            {!editCategoriesMode && (
                                                <button
                                                    draggable="false"
                                                    onDragStart={(e) => e.preventDefault()}
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        setEditingCategoryData({
                                                            category: category,
                                                            currentName: getCategoryDisplayName(category),
                                                            currentIcon: getCategoryDisplayIcon(category)
                                                        });
                                                        setShowEditCategoryModal(true);
                                                    }}
                                                    className="absolute -top-1 -right-1 bg-purple-600 text-white rounded-full w-5 h-5 flex items-center justify-center hover:bg-purple-700 text-xs opacity-0 group-hover:opacity-100 transition-opacity"
                                                    title="Edit category"
                                                >
                                                    ‚úèÔ∏è
                                                </button>
                                            )}
                                        </div>

                                        {/* Name with hover edit */}
                                        <div className="font-semibold text-gray-800 mb-1 flex items-center gap-2">
                                            <span className="truncate flex-1 pointer-events-none" title={displayName}>{truncatedName}</span>
                                            {!editCategoriesMode && (
                                                <button
                                                    draggable="false"
                                                    onDragStart={(e) => e.preventDefault()}
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        setEditingCategoryData({
                                                            category: category,
                                                            currentName: getCategoryDisplayName(category),
                                                            currentIcon: getCategoryDisplayIcon(category)
                                                        });
                                                        setShowEditCategoryModal(true);
                                                    }}
                                                    className="text-indigo-600 hover:text-indigo-700 opacity-0 group-hover:opacity-100 transition-opacity text-sm"
                                                    title="Edit category"
                                                >
                                                    ‚úèÔ∏è
                                                </button>
                                            )}
                                        </div>
                                        
                                        <div className="text-sm text-gray-600">{count} service{count !== 1 ? 's' : ''}</div>
                                        {!editCategoriesMode && (
                                            <div className="text-xs text-gray-500 mt-2 italic">Click to view ‚Ä¢ Drag to reorder</div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>

                        {/* My Vehicles Section */}
                        {vehicles.length > 0 && (
                            <div className="mb-8">
                                <div className="mb-4 flex justify-between items-center">
                                    <h2 className="text-2xl font-bold text-gray-800">üöó My Vehicles</h2>
                                    <button
                                        data-add-vehicle
                                        onClick={() => setShowAddVehicleModal(true)}
                                        className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-all font-semibold text-sm"
                                    >
                                        + Add Vehicle
                                    </button>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    {vehicles.map(vehicle => {
                                        const vehicleServices = getVehicleServices(vehicle.id);
                                        const monthlyCost = getVehicleMonthlyCost(vehicle.id);
                                        return (
                                            <div
                                                key={vehicle.id}
                                                onClick={() => {
                                                    setSelectedVehicle(vehicle);
                                                    setShowVehicleModal(true);
                                                }}
                                                className="glass-effect rounded-2xl p-6 cursor-pointer hover:shadow-xl transition-all"
                                            >
                                                <div className="flex justify-between items-start mb-3">
                                                    <div className="text-4xl">üöó</div>
                                                    <button
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            if (confirm(`Delete ${vehicle.nickname || vehicle.make + ' ' + vehicle.model}?`)) {
                                                                deleteVehicle(vehicle.id);
                                                            }
                                                        }}
                                                        className="text-red-600 hover:text-red-700 text-sm"
                                                    >
                                                        üóëÔ∏è
                                                    </button>
                                                </div>
                                                <h3 className="font-bold text-lg text-gray-800 mb-1">
                                                    {vehicle.nickname || `${vehicle.make} ${vehicle.model}`}
                                                </h3>
                                                <p className="text-sm text-gray-600 mb-3">
                                                    {vehicle.year} {vehicle.color && `‚Ä¢ ${vehicle.color}`}
                                                </p>
                                                <div className="border-t border-gray-200 pt-3">
                                                    <div className="text-2xl font-bold text-blue-600 mb-1">
                                                        ${monthlyCost.toFixed(2)}
                                                        <span className="text-sm text-gray-600 font-normal">/month</span>
                                                    </div>
                                                    <div className="text-sm text-gray-600">
                                                        üìã {vehicleServices.length} service{vehicleServices.length !== 1 ? 's' : ''}
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {/* Add Vehicle Button when no vehicles */}
                        {vehicles.length === 0 && (
                            <div className="mb-8 glass-effect rounded-2xl p-8 text-center">
                                <div className="text-6xl mb-4">üöó</div>
                                <h3 className="text-xl font-bold text-gray-800 mb-2">Track Your Vehicles</h3>
                                <p className="text-gray-600 mb-4">
                                    Add your cars, motorcycles, or other vehicles to organize related expenses like insurance, registration, and fuel.
                                </p>
                                <button
                                    data-add-vehicle
                                    onClick={() => setShowAddVehicleModal(true)}
                                    className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl transition-all font-semibold"
                                >
                                    + Add Your First Vehicle
                                </button>
                            </div>
                        )}

                        {/* Recent Services */}
                        {viewMode === 'dashboard' && (
                            <div className="glass-effect rounded-2xl p-6 shadow-xl">
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-2xl font-bold text-gray-800">All Services</h2>
                                    <div className="flex gap-3">
                                        {services.length > 0 && (
                                            <button
                                                onClick={() => {
                                                    setBulkDeleteMode(!bulkDeleteMode);
                                                    setSelectedServices([]);
                                                }}
                                                className={`${
                                                    bulkDeleteMode 
                                                        ? 'bg-red-600 hover:bg-red-700' 
                                                        : 'bg-gray-600 hover:bg-gray-700'
                                                } text-white px-4 py-2 rounded-lg transition-all font-semibold`}
                                            >
                                                {bulkDeleteMode ? '‚úì Done' : '‚òë Select'}
                                            </button>
                                        )}
                                        {bulkDeleteMode && selectedServices.length > 0 && (
                                            <button
                                                onClick={bulkDeleteServices}
                                                className="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-all font-semibold"
                                            >
                                                üóëÔ∏è Delete {selectedServices.length}
                                            </button>
                                        )}
                                    </div>
                                </div>
                                {services.length === 0 ? (
                                    <div className="text-center py-12 text-gray-500">
                                        <div className="text-5xl mb-4">üìã</div>
                                        <p>No services added yet. Click "Add Service" to get started!</p>
                                    </div>
                                ) : (
                                    <div className="space-y-3">
                                        {getSortedServices()
                                            .map((service, index, array) => {
                                            const category = categories.find(c => c.id === service.category);
                                            const isSelected = selectedServices.includes(service.id);
                                            
                                            // Check if this is the first paused service (show separator)
                                            const isFirstPaused = !service.isPaused === false && 
                                                (index === 0 || !array[index - 1].isPaused === true);
                                            const showSeparator = index > 0 && service.isPaused && !array[index - 1].isPaused;
                                            
                                            return (
                                                <React.Fragment key={service.id}>
                                                    {showSeparator && (
                                                        <div className="flex items-center gap-3 py-2">
                                                            <div className="flex-1 border-t-2 border-gray-300"></div>
                                                            <span className="text-sm font-semibold text-gray-500 px-3">‚è∏ PAUSED SERVICES</span>
                                                            <div className="flex-1 border-t-2 border-gray-300"></div>
                                                        </div>
                                                    )}
                                                    <div
                                                        draggable={!bulkDeleteMode}
                                                        onDragStart={(e) => {
                                                            if (!bulkDeleteMode) {
                                                                e.stopPropagation();
                                                                handleServiceDragStart(index);
                                                            } else {
                                                                e.preventDefault();
                                                            }
                                                        }}
                                                        onDragEnter={(e) => {
                                                            if (!bulkDeleteMode) {
                                                                e.preventDefault();
                                                            }
                                                        }}
                                                        onDragOver={(e) => {
                                                            if (!bulkDeleteMode) {
                                                                e.preventDefault();
                                                                e.stopPropagation();
                                                                handleServiceDragOver(e, index);
                                                            }
                                                        }}
                                                        onDragEnd={(e) => {
                                                            if (!bulkDeleteMode) {
                                                                e.stopPropagation();
                                                                handleServiceDragEnd();
                                                            }
                                                        }}
                                                        onClick={() => {
                                                            if (bulkDeleteMode) {
                                                                toggleServiceSelection(service.id);
                                                            } else if (draggedServiceIndex === null) {
                                                                setSelectedService(service);
                                                                setShowServiceDetailModal(true);
                                                            }
                                                        }}
                                                        className={`service-item p-4 rounded-xl ${!bulkDeleteMode ? 'cursor-move' : 'cursor-pointer'} border-2 transition-all ${
                                                            isSelected ? 'border-red-500 bg-red-50' : 'border-gray-200'
                                                        } ${service.isPaused ? 'opacity-50 bg-gray-100' : ''} ${
                                                            draggedServiceIndex === index ? 'opacity-30 scale-95' : ''
                                                        }`}
                                                    >
                                                    <div className="flex justify-between items-center">
                                                        <div className="flex items-center space-x-4">
                                                            {bulkDeleteMode && (
                                                                <input
                                                                    type="checkbox"
                                                                    checked={isSelected}
                                                                    onChange={() => toggleServiceSelection(service.id)}
                                                                    onClick={(e) => e.stopPropagation()}
                                                                    className="w-5 h-5 text-red-600 cursor-pointer"
                                                                />
                                                            )}
                                                            <div className="text-3xl">{getCategoryDisplayIcon(category)}</div>
                                                            <div>
                                                                <div className="font-semibold text-gray-800 flex items-center gap-2">
                                                                    {service.provider}
                                                                    {service.isPaused && (
                                                                        <span className="text-xs bg-gray-600 text-white px-2 py-1 rounded-full">‚è∏ Paused</span>
                                                                    )}
                                                                </div>
                                                                <div className="text-sm text-gray-600">{getCategoryDisplayName(category)}</div>
                                                            </div>
                                                        </div>
                                                        <div className="text-right">
                                                            <div className="font-bold text-indigo-600">${service.cost}</div>
                                                            <div className="text-sm text-gray-600">{service.billingCycle}</div>
                                                        </div>
                                                    </div>
                                                </div>
                                                </React.Fragment>
                                            );
                                        })}
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                    )}

                    {/* Modals - Available regardless of auth state */}
                    {/* Add Service Modal */}
                    {showAddModal && (
                        <AddServiceModal
                            onClose={() => {
                                setShowAddModal(false);
                                setPreSelectedCategory(null);
                                setPreSelectedVehicle(null);
                            }}
                            onAdd={addService}
                            categories={categories}
                            categoryOrder={categoryOrder}
                            hiddenCategories={hiddenCategories}
                            categoryCustomizations={categoryCustomizations}
                            customCategoryName={customCategoryName}
                            customCategoryIcon={customCategoryIcon}
                            preSelectedCategory={preSelectedCategory}
                            vehicles={vehicles}
                            preSelectedVehicle={preSelectedVehicle}
                        />
                    )}

                    {/* Edit Service Modal */}
                    {showEditModal && selectedService && (
                        <EditServiceModal
                            service={selectedService}
                            onClose={() => setShowEditModal(false)}
                            onEdit={editService}
                            categories={categories}
                            categoryOrder={categoryOrder}
                            hiddenCategories={hiddenCategories}
                            categoryCustomizations={categoryCustomizations}
                            customCategoryName={customCategoryName}
                            customCategoryIcon={customCategoryIcon}
                            vehicles={vehicles}
                        />
                    )}

                    {/* Category Modal */}
                    {showCategoryModal && selectedCategory && (
                        <CategoryModal
                            category={selectedCategory}
                            customCategoryName={customCategoryName}
                            customCategoryIcon={customCategoryIcon}
                            categoryCustomizations={categoryCustomizations}
                            services={getServicesByCategory(selectedCategory.id)}
                            onClose={() => {
                                setShowCategoryModal(false);
                                setSelectedCategory(null);
                            }}
                            onServiceClick={(service) => {
                                setSelectedService(service);
                                setShowServiceDetailModal(true);
                            }}
                            onAddService={() => {
                                setPreSelectedCategory(selectedCategory.id);
                                setShowAddModal(true);
                            }}
                            onDelete={deleteService}
                        />
                    )}

                    {/* Category Picker Modal */}
                    {showCategoryPickerModal && (
                        <CategoryPickerModal
                            categories={categories}
                            categoryOrder={categoryOrder}
                            hiddenCategories={hiddenCategories}
                            categoryCustomizations={categoryCustomizations}
                            customCategoryName={customCategoryName}
                            customCategoryIcon={customCategoryIcon}
                            onClose={() => setShowCategoryPickerModal(false)}
                            onUnhideMultiple={(categoryIds) => {
                                // Unhide all selected categories at once
                                setHiddenCategories(prev => prev.filter(id => !categoryIds.includes(id)));
                            }}
                            onDeletePermanently={(categoryId) => {
                                // Remove from hidden categories
                                setHiddenCategories(prev => prev.filter(id => id !== categoryId));
                                // Remove from category order
                                setCategoryOrder(prev => prev.filter(id => id !== categoryId));
                                // Remove customizations
                                setCategoryCustomizations(prev => {
                                    const updated = {...prev};
                                    delete updated[categoryId];
                                    return updated;
                                });
                                // Remove custom category from categories array
                                if (categoryId.startsWith('custom_')) {
                                    setCategories(prev => prev.filter(cat => cat.id !== categoryId));
                                }
                            }}
                            onCreateCustom={() => {
                                setShowCategoryPickerModal(false);
                                setShowCreateCustomCategoryModal(true);
                            }}
                        />
                    )}

                    {/* Create Custom Category Modal */}
                    {showCreateCustomCategoryModal && (
                        <CreateCustomCategoryModal
                            onClose={() => setShowCreateCustomCategoryModal(false)}
                            onCreate={(categoryName, categoryIcon) => {
                                const customId = `custom_${Date.now()}`;
                                
                                setCategories([...categories, { 
                                    id: customId, 
                                    name: categoryName, 
                                    icon: categoryIcon,
                                    color: 'bg-gray-500'
                                }]);
                                
                                setCategoryOrder([...categoryOrder, customId]);
                                updateCategoryCustomization(customId, 'name', categoryName);
                                updateCategoryCustomization(customId, 'icon', categoryIcon);
                            }}
                        />
                    )}

                    {/* Edit Category Modal */}
                    {showEditCategoryModal && editingCategoryData && (
                        <EditCategoryModal
                            category={editingCategoryData.category}
                            currentName={editingCategoryData.currentName}
                            currentIcon={editingCategoryData.currentIcon}
                            onClose={() => {
                                setShowEditCategoryModal(false);
                                setEditingCategoryData(null);
                            }}
                            onSave={(newName, newIcon) => {
                                if (editingCategoryData.category.id === 'custom') {
                                    setCustomCategoryName(newName);
                                    setCustomCategoryIcon(newIcon);
                                } else {
                                    updateCategoryCustomization(editingCategoryData.category.id, 'name', newName);
                                    updateCategoryCustomization(editingCategoryData.category.id, 'icon', newIcon);
                                }
                            }}
                        />
                    )}

                    {/* Service Detail Modal */}
                    {showServiceDetailModal && selectedService && (
                        <ServiceDetailModal
                            service={selectedService}
                            categories={categories}
                            customCategoryName={customCategoryName}
                            customCategoryIcon={customCategoryIcon}
                            categoryCustomizations={categoryCustomizations}
                            onClose={() => {
                                setShowServiceDetailModal(false);
                                setSelectedService(null);
                            }}
                            onEdit={() => {
                                setShowEditModal(true);
                                setShowServiceDetailModal(false); // Close the service detail modal
                                setShowCategoryModal(false); // Close the category modal
                            }}
                            onDelete={deleteService}
                            onTogglePause={togglePause}
                        />
                    )}

                    {/* Auth Modal */}
                    {showAuthModal && (
                        <AuthModal onClose={() => setShowAuthModal(false)} />
                    )}

                    {/* Notification Settings Modal */}
                    {showNotificationSettings && (
                        <NotificationSettingsModal 
                            preferences={notificationPreferences}
                            upcomingRenewals={upcomingRenewals}
                            onClose={() => setShowNotificationSettings(false)}
                            onSave={(prefs) => {
                                setNotificationPreferences(prefs);
                                setShowNotificationSettings(false);
                            }}
                            categories={categories}
                            customCategoryName={customCategoryName}
                            customCategoryIcon={customCategoryIcon}
                            categoryCustomizations={categoryCustomizations}
                        />
                    )}

                    {/* Add Vehicle Modal */}
                    {showAddVehicleModal && (
                        <AddVehicleModal
                            onClose={() => setShowAddVehicleModal(false)}
                            onAdd={addVehicle}
                        />
                    )}
                    
                    {/* Import CSV Modal */}
                    {showImportModal && (
                        <ImportCSVModal
                            detectedSubscriptions={detectedSubscriptions}
                            selectedImports={selectedImports}
                            onClose={() => {
                                setShowImportModal(false);
                                setDetectedSubscriptions([]);
                                setSelectedImports([]);
                            }}
                            onUpload={handleCSVUpload}
                            onToggleSelect={(index) => {
                                setSelectedImports(prev => 
                                    prev.includes(index) 
                                        ? prev.filter(i => i !== index)
                                        : [...prev, index]
                                );
                            }}
                            onImport={handleImportSelected}
                        />
                    )}

                    {/* Vehicle Detail Modal */}
                    {showVehicleModal && selectedVehicle && (
                        <VehicleModal
                            vehicle={selectedVehicle}
                            services={getVehicleServices(selectedVehicle.id)}
                            onClose={() => {
                                setShowVehicleModal(false);
                                setSelectedVehicle(null);
                            }}
                            onAddService={(vehicleId) => {
                                setPreSelectedVehicle(vehicleId);
                                setShowAddModal(true);
                            }}
                            categories={categories}
                            customCategoryName={customCategoryName}
                            customCategoryIcon={customCategoryIcon}
                            categoryCustomizations={categoryCustomizations}
                        />
                    )}
                </div>
            );
        }

        function DetailField({ label, value }) {
            return (
                <div>
                    <div className="text-sm font-semibold text-gray-700 mb-1">{label}</div>
                    <div className="bg-gray-50 p-3 rounded-lg text-gray-800">{value}</div>
                </div>
            );
        }

        function EditCategoryModal({ category, currentName, currentIcon, onClose, onSave }) {
            const [categoryName, setCategoryName] = useState(currentName);
            const [categoryIcon, setCategoryIcon] = useState(currentIcon);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!categoryName.trim()) return;
                onSave(categoryName.trim().substring(0, 30), categoryIcon.trim().substring(0, 2));
                onClose();
            };

            return (
                <div 
                    className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"
                    onClick={(e) => {
                        if (e.target === e.currentTarget) {
                            onClose();
                        }
                    }}
                >
                    <div className="glass-effect rounded-2xl p-8 max-w-md w-full">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-gray-800">‚úèÔ∏è Edit Category</h2>
                            <button onClick={onClose} className="text-gray-600 hover:text-gray-800 text-3xl">√ó</button>
                        </div>

                        <form onSubmit={handleSubmit} className="space-y-5">
                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-2">Category Name</label>
                                <input
                                    type="text"
                                    value={categoryName}
                                    onChange={(e) => setCategoryName(e.target.value)}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                    maxLength={30}
                                    required
                                    autoFocus
                                />
                                <div className="text-xs text-gray-500 mt-1">{categoryName.length}/30 characters</div>
                            </div>

                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-2">Category Emoji</label>
                                <input
                                    type="text"
                                    value={categoryIcon}
                                    onChange={(e) => setCategoryIcon(e.target.value)}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-2xl"
                                    maxLength={2}
                                    required
                                />
                            </div>

                            <div className="flex space-x-4 pt-4">
                                <button
                                    type="submit"
                                    className="flex-1 bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-3 rounded-xl hover:shadow-lg transition-all font-semibold"
                                >
                                    Save Changes
                                </button>
                                <button
                                    type="button"
                                    onClick={onClose}
                                    className="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl hover:bg-gray-300 transition-all font-semibold"
                                >
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function CreateCustomCategoryModal({ onClose, onCreate }) {
            const [categoryName, setCategoryName] = useState('');
            const [categoryIcon, setCategoryIcon] = useState('‚ú®');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!categoryName.trim()) return;
                onCreate(categoryName.trim().substring(0, 30), categoryIcon.trim().substring(0, 2));
                onClose();
            };

            return (
                <div 
                    className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"
                    onClick={(e) => {
                        if (e.target === e.currentTarget) {
                            onClose();
                        }
                    }}
                >
                    <div className="glass-effect rounded-2xl p-8 max-w-md w-full">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-gray-800">‚ú® Create Custom Category</h2>
                            <button onClick={onClose} className="text-gray-600 hover:text-gray-800 text-3xl">√ó</button>
                        </div>

                        <form onSubmit={handleSubmit} className="space-y-5">
                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-2">Category Name</label>
                                <input
                                    type="text"
                                    value={categoryName}
                                    onChange={(e) => setCategoryName(e.target.value)}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                    placeholder="e.g., Pets, Education, Healthcare"
                                    maxLength={30}
                                    required
                                    autoFocus
                                />
                                <div className="text-xs text-gray-500 mt-1">{categoryName.length}/30 characters</div>
                            </div>

                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-2">Category Emoji</label>
                                <input
                                    type="text"
                                    value={categoryIcon}
                                    onChange={(e) => setCategoryIcon(e.target.value)}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-2xl"
                                    placeholder="‚ú®"
                                    maxLength={2}
                                    required
                                />
                                <div className="text-xs text-gray-500 mt-1">Choose an emoji to represent this category</div>
                            </div>

                            <div className="flex space-x-4 pt-4">
                                <button
                                    type="submit"
                                    className="flex-1 bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-3 rounded-xl hover:shadow-lg transition-all font-semibold"
                                >
                                    Create Category
                                </button>
                                <button
                                    type="button"
                                    onClick={onClose}
                                    className="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl hover:bg-gray-300 transition-all font-semibold"
                                >
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function CategoryPickerModal({ categories, categoryOrder, hiddenCategories, categoryCustomizations, customCategoryName, customCategoryIcon, onClose, onUnhideMultiple, onDeletePermanently, onCreateCustom }) {
            const [selectedCategories, setSelectedCategories] = useState([]);
            
            const handleBackdropClick = (e) => {
                if (e.target === e.currentTarget) {
                    onClose();
                }
            };

            // Helper functions to get correct display names and icons
            const getCategoryDisplayName = (cat) => {
                if (cat.id === 'custom') return customCategoryName;
                return categoryCustomizations[cat.id]?.name || cat.name;
            };

            const getCategoryDisplayIcon = (cat) => {
                if (cat.id === 'custom') return customCategoryIcon;
                return categoryCustomizations[cat.id]?.icon || cat.icon;
            };

            // Get visible categories: must be in categoryOrder AND not hidden
            const visibleCategories = categoryOrder
                .map(id => categories.find(cat => cat.id === id))
                .filter(Boolean)
                .filter(cat => !hiddenCategories.includes(cat.id));
            
            // Hidden categories: in hiddenCategories list
            const hiddenCategoryList = categories.filter(cat => hiddenCategories.includes(cat.id));

            const toggleSelectCategory = (categoryId) => {
                setSelectedCategories(prev => 
                    prev.includes(categoryId) 
                        ? prev.filter(id => id !== categoryId)
                        : [...prev, categoryId]
                );
            };

            const unhideSelected = () => {
                // Unhide all selected categories at once
                onUnhideMultiple(selectedCategories);
                // Close modal after unhiding
                onClose();
            };

            const deleteSelected = () => {
                if (window.confirm(`Are you sure you want to permanently delete ${selectedCategories.length} ${selectedCategories.length === 1 ? 'category' : 'categories'}? This cannot be undone.`)) {
                    selectedCategories.forEach(categoryId => {
                        onDeletePermanently(categoryId);
                    });
                    setSelectedCategories([]);
                }
            };

            return (
                <div 
                    className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"
                    onClick={handleBackdropClick}
                >
                    <div className="glass-effect rounded-2xl p-8 max-w-3xl w-full max-h-[85vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-gray-800">Add Category</h2>
                            <button onClick={onClose} className="text-gray-600 hover:text-gray-800 text-3xl">√ó</button>
                        </div>

                        {/* Create Custom - At the top */}
                        <div className="mb-6 border-2 border-purple-300 rounded-2xl p-6 bg-purple-50">
                            <h3 className="text-lg font-semibold text-gray-800 mb-2">‚ú® Create Custom Category</h3>
                            <p className="text-sm text-gray-600 mb-4">Make your own category with a custom name and emoji</p>
                            <button
                                onClick={onCreateCustom}
                                className="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-3 rounded-xl hover:shadow-lg transition-all font-semibold"
                            >
                                + Create Custom Category
                            </button>
                        </div>

                        {hiddenCategoryList.length > 0 && (
                            <div className="mb-6">
                                <div className="flex justify-between items-center mb-3">
                                    <div>
                                        <h3 className="text-lg font-semibold text-gray-700">Hidden Categories</h3>
                                        <p className="text-sm text-gray-600">
                                            Select categories to unhide or delete permanently
                                        </p>
                                    </div>
                                    {selectedCategories.length > 0 && (
                                        <div className="flex gap-2">
                                            <button
                                                onClick={unhideSelected}
                                                className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold text-sm transition-all"
                                            >
                                                ‚úì Unhide {selectedCategories.length}
                                            </button>
                                            <button
                                                onClick={deleteSelected}
                                                className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-semibold text-sm transition-all"
                                            >
                                                üóëÔ∏è Delete {selectedCategories.length}
                                            </button>
                                        </div>
                                    )}
                                </div>
                                <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                                    {hiddenCategoryList.map(category => {
                                        const isSelected = selectedCategories.includes(category.id);
                                        return (
                                            <button
                                                key={category.id}
                                                onClick={() => toggleSelectCategory(category.id)}
                                                className={`glass-effect rounded-xl p-4 border-2 transition-all text-left ${
                                                    isSelected 
                                                        ? 'border-purple-500 bg-purple-50 shadow-lg'
                                                        : 'border-gray-300 hover:border-purple-400'
                                                }`}
                                            >
                                                <div className="flex justify-between items-start mb-2">
                                                    <div className="text-3xl">{getCategoryDisplayIcon(category)}</div>
                                                    {isSelected && (
                                                        <div className="bg-purple-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs">
                                                            ‚úì
                                                        </div>
                                                    )}
                                                </div>
                                                <div className="font-semibold text-gray-800 text-sm">{getCategoryDisplayName(category)}</div>
                                                <div className={`text-xs mt-1 ${isSelected ? 'text-purple-600' : 'text-gray-500'}`}>
                                                    {isSelected ? 'Selected' : 'Click to select'}
                                                </div>
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        <div className="border-t border-gray-200 pt-6">
                            <h3 className="text-lg font-semibold text-gray-700 mb-3">Currently Visible</h3>
                            <p className="text-sm text-gray-600 mb-4">These categories are already on your dashboard</p>
                            <div className="grid grid-cols-2 md:grid-cols-3 gap-3 opacity-60">
                                {visibleCategories.map(category => (
                                    <div
                                        key={category.id}
                                        className="glass-effect rounded-xl p-4 border-2 border-gray-200"
                                    >
                                        <div className="text-3xl mb-2">{getCategoryDisplayIcon(category)}</div>
                                        <div className="font-semibold text-gray-800 text-sm">{getCategoryDisplayName(category)}</div>
                                        <div className="text-xs text-gray-500 mt-1">‚úì Visible</div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function AddServiceModal({ onClose, onAdd, categories, categoryOrder, hiddenCategories, categoryCustomizations, customCategoryName, customCategoryIcon, preSelectedCategory, vehicles = [], preSelectedVehicle = null }) {
            const [formData, setFormData] = useState({
                category: preSelectedCategory || 'internet',
                provider: '',
                cost: '',
                billingCycle: 'monthly',
                startDate: '',
                renewalDate: '',
                accountNumber: '',
                username: '',
                password: '',
                phone: '',
                notes: '',
                vehicleId: preSelectedVehicle || null
            });

            const [showOptional, setShowOptional] = useState(false);

            // Helper functions to get correct display names and icons
            const getCategoryDisplayName = (cat) => {
                if (cat.id === 'custom') return customCategoryName;
                return categoryCustomizations[cat.id]?.name || cat.name;
            };

            const getCategoryDisplayIcon = (cat) => {
                if (cat.id === 'custom') return customCategoryIcon;
                return categoryCustomizations[cat.id]?.icon || cat.icon;
            };

            // Filter to only show visible categories (in categoryOrder and not hidden)
            const visibleCategories = categoryOrder
                .map(id => categories.find(cat => cat.id === id))
                .filter(Boolean)
                .filter(cat => !hiddenCategories.includes(cat.id));

            const handleSubmit = (e) => {
                e.preventDefault();
                onAdd({
                    ...formData,
                    cost: parseFloat(formData.cost),
                    vehicleId: formData.vehicleId || null
                });
                onClose();
            };

            // Category-specific placeholder examples
            const getProviderPlaceholder = (categoryId) => {
                const placeholders = {
                    'internet': 'e.g., Spectrum, Comcast, AT&T',
                    'utilities': 'e.g., Pacific Gas & Electric, Con Edison',
                    'subscriptions': 'e.g., Netflix, Spotify, Disney+',
                    'insurance': 'e.g., State Farm, Geico, Blue Cross',
                    'financial': 'e.g., Chase, Bank of America, Amex',
                    'home': 'e.g., Merry Maids, TruGreen, ADT',
                    'vehicles': 'e.g., Toyota Dealership, AAA, Hertz',
                    'memberships': 'e.g., LA Fitness, Costco, AAA',
                    'custom': 'e.g., Your service name'
                };
                return placeholders[categoryId] || 'e.g., Service name';
            };

            return (
                <div 
                    className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"
                    onClick={(e) => {
                        if (e.target === e.currentTarget) {
                            onClose();
                        }
                    }}
                >
                    <div className="glass-effect rounded-2xl p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-gray-800">Add New Service</h2>
                            <button onClick={onClose} className="text-gray-600 hover:text-gray-800 text-2xl">√ó</button>
                        </div>
                        
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-2">Category</label>
                                <select
                                    value={formData.category}
                                    onChange={(e) => setFormData({...formData, category: e.target.value})}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                    required
                                >
                                    {visibleCategories.map(cat => (
                                        <option key={cat.id} value={cat.id}>
                                            {getCategoryDisplayIcon(cat)} {getCategoryDisplayName(cat)}
                                        </option>
                                    ))}
                                </select>
                            </div>

                            {/* Vehicle Assignment - Show when category is vehicles OR when vehicles exist */}
                            {(formData.category === 'vehicles' || vehicles.length > 0) && (
                                <div className={formData.category === 'vehicles' ? 'border-2 border-blue-300 rounded-lg p-4 bg-blue-50' : ''}>
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">
                                        üöó Assign to Vehicle {formData.category === 'vehicles' ? '(Recommended)' : '(Optional)'}
                                    </label>
                                    {vehicles.length === 0 ? (
                                        <div className="text-sm text-gray-600 mb-2">
                                            <p>No vehicles added yet. Click the button below to add your first vehicle, then come back to link this service.</p>
                                            <button 
                                                type="button"
                                                onClick={() => {
                                                    onClose(); // Close the add service modal
                                                    // Small delay to allow modal close animation
                                                    setTimeout(() => {
                                                        const addVehicleBtn = document.querySelector('[data-add-vehicle]');
                                                        if (addVehicleBtn) addVehicleBtn.click();
                                                    }, 300);
                                                }}
                                                className="mt-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition-all"
                                            >
                                                üöó Add Vehicle First
                                            </button>
                                        </div>
                                    ) : (
                                        <select
                                            value={formData.vehicleId || ''}
                                            onChange={(e) => setFormData({...formData, vehicleId: e.target.value ? parseInt(e.target.value) : null})}
                                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                        >
                                            <option value="">None - General service</option>
                                            {vehicles.map(vehicle => (
                                                <option key={vehicle.id} value={vehicle.id}>
                                                    {vehicle.nickname || `${vehicle.make} ${vehicle.model}`}
                                                    {vehicle.year && ` (${vehicle.year})`}
                                                </option>
                                            ))}
                                        </select>
                                    )}
                                </div>
                            )}

                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-2">Provider/Service Name</label>
                                <input
                                    type="text"
                                    value={formData.provider}
                                    onChange={(e) => setFormData({...formData, provider: e.target.value})}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                    placeholder={getProviderPlaceholder(formData.category)}
                                    required
                                />
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">Cost ($)</label>
                                    <input
                                        type="number"
                                        step="0.01"
                                        value={formData.cost}
                                        onChange={(e) => setFormData({...formData, cost: e.target.value})}
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                        placeholder="79.99"
                                        required
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">Billing Cycle</label>
                                    <select
                                        value={formData.billingCycle}
                                        onChange={(e) => setFormData({...formData, billingCycle: e.target.value})}
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                    >
                                        <option value="one-time">One-Time Purchase</option>
                                        <option value="weekly">Weekly</option>
                                        <option value="monthly">Monthly</option>
                                        <option value="yearly">Yearly</option>
                                    </select>
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">Start Date</label>
                                    <input
                                        type="date"
                                        value={formData.startDate}
                                        onChange={(e) => setFormData({...formData, startDate: e.target.value})}
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">Renewal Date</label>
                                    <input
                                        type="date"
                                        value={formData.renewalDate}
                                        onChange={(e) => setFormData({...formData, renewalDate: e.target.value})}
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                    />
                                </div>
                            </div>


                            {/* Collapsible Optional Fields */}
                            <div className="border-t border-gray-200 pt-4">
                                <button
                                    type="button"
                                    onClick={() => setShowOptional(!showOptional)}
                                    className="flex items-center justify-between w-full text-left p-3 bg-gray-50 hover:bg-gray-100 rounded-lg transition-all"
                                >
                                    <span className="text-sm font-semibold text-gray-700">
                                        üìã Optional Details (Account, Login, Contact)
                                    </span>
                                    <span className="text-gray-600 text-xl">
                                        {showOptional ? '‚ñº' : '‚ñ∂'}
                                    </span>
                                </button>

                                {showOptional && (
                                    <div className="mt-4 space-y-4">
                                        <div>
                                            <label className="block text-sm font-semibold text-gray-700 mb-2">Account Number</label>
                                            <input
                                                type="text"
                                                value={formData.accountNumber}
                                                onChange={(e) => setFormData({...formData, accountNumber: e.target.value})}
                                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                                placeholder="Optional"
                                            />
                                        </div>

                                        <div className="grid grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-sm font-semibold text-gray-700 mb-2">Username/Email</label>
                                                <input
                                                    type="text"
                                                    value={formData.username}
                                                    onChange={(e) => setFormData({...formData, username: e.target.value})}
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                                    placeholder="Optional"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-semibold text-gray-700 mb-2">Password</label>
                                                <input
                                                    type="password"
                                                    value={formData.password}
                                                    onChange={(e) => setFormData({...formData, password: e.target.value})}
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                                    placeholder="Optional"
                                                />
                                            </div>
                                        </div>

                                        <div>
                                            <label className="block text-sm font-semibold text-gray-700 mb-2">Contact Phone</label>
                                            <input
                                                type="tel"
                                                value={formData.phone}
                                                onChange={(e) => setFormData({...formData, phone: e.target.value})}
                                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                                placeholder="Optional"
                                            />
                                        </div>
                                    </div>
                                )}
                            </div>

                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-2">Notes</label>
                                <textarea
                                    value={formData.notes}
                                    onChange={(e) => setFormData({...formData, notes: e.target.value})}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                    rows="3"
                                    placeholder="Any additional information..."
                                />
                            </div>

                            <div className="flex space-x-4 pt-4">
                                <button
                                    type="submit"
                                    className="flex-1 bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-3 rounded-xl hover:shadow-lg transition-all font-semibold"
                                >
                                    Add Service
                                </button>
                                <button
                                    type="button"
                                    onClick={onClose}
                                    className="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl hover:bg-gray-300 transition-all font-semibold"
                                >
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function EditServiceModal({ service, onClose, onEdit, categories, categoryOrder, hiddenCategories, categoryCustomizations, customCategoryName, customCategoryIcon, vehicles }) {
            const [formData, setFormData] = useState({
                id: service.id,
                category: service.category,
                provider: service.provider,
                cost: service.cost,
                billingCycle: service.billingCycle,
                startDate: service.startDate || '',
                renewalDate: service.renewalDate || '',
                accountNumber: service.accountNumber || '',
                username: service.username || '',
                password: service.password || '',
                phone: service.phone || '',
                notes: service.notes || '',
                vehicleId: service.vehicleId || null,
                // Vehicle-specific fields
                vehicleMake: service.vehicleMake || '',
                vehicleModel: service.vehicleModel || '',
                vehicleBodyType: service.vehicleBodyType || '',
                vehicleYear: service.vehicleYear || ''
            });

            // Helper functions to get correct display names and icons
            const getCategoryDisplayName = (cat) => {
                if (cat.id === 'custom') return customCategoryName;
                return categoryCustomizations[cat.id]?.name || cat.name;
            };

            const getCategoryDisplayIcon = (cat) => {
                if (cat.id === 'custom') return customCategoryIcon;
                return categoryCustomizations[cat.id]?.icon || cat.icon;
            };

            // Filter to only show visible categories (in categoryOrder and not hidden)
            const visibleCategories = categoryOrder
                .map(id => categories.find(cat => cat.id === id))
                .filter(Boolean)
                .filter(cat => !hiddenCategories.includes(cat.id));

            const handleSubmit = (e) => {
                e.preventDefault();
                onEdit({
                    ...formData,
                    cost: parseFloat(formData.cost),
                    vehicleId: formData.vehicleId || null
                });
            };

            // Category-specific placeholder examples
            const getProviderPlaceholder = (categoryId) => {
                const placeholders = {
                    'internet': 'e.g., Spectrum, Comcast, AT&T',
                    'utilities': 'e.g., Pacific Gas & Electric, Con Edison',
                    'subscriptions': 'e.g., Netflix, Spotify, Disney+',
                    'insurance': 'e.g., State Farm, Geico, Blue Cross',
                    'financial': 'e.g., Chase, Bank of America, Amex',
                    'home': 'e.g., Merry Maids, TruGreen, ADT',
                    'vehicles': 'e.g., Toyota Dealership, AAA, Hertz',
                    'memberships': 'e.g., LA Fitness, Costco, AAA',
                    'custom': 'e.g., Your service name'
                };
                return placeholders[categoryId] || 'e.g., Service name';
            };

            return (
                <div 
                    className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"
                    onClick={(e) => {
                        if (e.target === e.currentTarget) {
                            onClose();
                        }
                    }}
                >
                    <div className="glass-effect rounded-2xl p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-gray-800">Edit Service</h2>
                            <button onClick={onClose} className="text-gray-600 hover:text-gray-800 text-2xl">√ó</button>
                        </div>
                        
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-2">Category</label>
                                <select
                                    value={formData.category}
                                    onChange={(e) => setFormData({...formData, category: e.target.value})}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                    required
                                >
                                    {visibleCategories.map(cat => (
                                        <option key={cat.id} value={cat.id}>
                                            {getCategoryDisplayIcon(cat)} {getCategoryDisplayName(cat)}
                                        </option>
                                    ))}
                                </select>
                            </div>

                            {/* Vehicle Assignment - Show when category is vehicles OR when vehicles exist */}
                            {(formData.category === 'vehicles' || (vehicles && vehicles.length > 0)) && (
                                <div className={formData.category === 'vehicles' ? 'border-2 border-blue-300 rounded-lg p-4 bg-blue-50' : ''}>
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">
                                        üöó Assign to Vehicle {formData.category === 'vehicles' ? '(Recommended)' : '(Optional)'}
                                    </label>
                                    {(!vehicles || vehicles.length === 0) ? (
                                        <div className="text-sm text-gray-600">
                                            <p>No vehicles added yet.</p>
                                        </div>
                                    ) : (
                                        <select
                                            value={formData.vehicleId || ''}
                                            onChange={(e) => setFormData({...formData, vehicleId: e.target.value ? parseInt(e.target.value) : null})}
                                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                        >
                                            <option value="">None - General service</option>
                                            {vehicles.map(vehicle => (
                                                <option key={vehicle.id} value={vehicle.id}>
                                                    {vehicle.nickname || `${vehicle.make} ${vehicle.model}`}
                                                    {vehicle.year && ` (${vehicle.year})`}
                                                </option>
                                            ))}
                                        </select>
                                    )}
                                </div>
                            )}

                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-2">Provider/Service Name</label>
                                <input
                                    type="text"
                                    value={formData.provider}
                                    onChange={(e) => setFormData({...formData, provider: e.target.value})}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                    placeholder={getProviderPlaceholder(formData.category)}
                                    required
                                />
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">Cost ($)</label>
                                    <input
                                        type="number"
                                        step="0.01"
                                        value={formData.cost}
                                        onChange={(e) => setFormData({...formData, cost: e.target.value})}
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                        placeholder="79.99"
                                        required
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">Billing Cycle</label>
                                    <select
                                        value={formData.billingCycle}
                                        onChange={(e) => setFormData({...formData, billingCycle: e.target.value})}
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                    >
                                        <option value="one-time">One-Time Purchase</option>
                                        <option value="weekly">Weekly</option>
                                        <option value="monthly">Monthly</option>
                                        <option value="yearly">Yearly</option>
                                    </select>
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">Start Date</label>
                                    <input
                                        type="date"
                                        value={formData.startDate}
                                        onChange={(e) => setFormData({...formData, startDate: e.target.value})}
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">Renewal Date</label>
                                    <input
                                        type="date"
                                        value={formData.renewalDate}
                                        onChange={(e) => setFormData({...formData, renewalDate: e.target.value})}
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                    />
                                </div>
                            </div>

                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-2">Account Number</label>
                                <input
                                    type="text"
                                    value={formData.accountNumber}
                                    onChange={(e) => setFormData({...formData, accountNumber: e.target.value})}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                    placeholder="Optional"
                                />
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">Username/Email</label>
                                    <input
                                        type="text"
                                        value={formData.username}
                                        onChange={(e) => setFormData({...formData, username: e.target.value})}
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                        placeholder="Optional"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">Password</label>
                                    <input
                                        type="password"
                                        value={formData.password}
                                        onChange={(e) => setFormData({...formData, password: e.target.value})}
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                        placeholder="Optional"
                                    />
                                </div>
                            </div>

                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-2">Contact Phone</label>
                                <input
                                    type="tel"
                                    value={formData.phone}
                                    onChange={(e) => setFormData({...formData, phone: e.target.value})}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                    placeholder="Optional"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-2">Notes</label>
                                <textarea
                                    value={formData.notes}
                                    onChange={(e) => setFormData({...formData, notes: e.target.value})}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                    rows="3"
                                    placeholder="Any additional information..."
                                />
                            </div>

                            <div className="flex space-x-4 pt-4">
                                <button
                                    type="submit"
                                    className="flex-1 bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-3 rounded-xl hover:shadow-lg transition-all font-semibold"
                                >
                                    Save Changes
                                </button>
                                <button
                                    type="button"
                                    onClick={onClose}
                                    className="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl hover:bg-gray-300 transition-all font-semibold"
                                >
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function CategoryModal({ category, customCategoryName, customCategoryIcon, categoryCustomizations, services, onClose, onServiceClick, onAddService, onDelete }) {
            const handleAddService = () => {
                onClose(); // Close category modal first
                onAddService(); // Then open Add Service modal
            };

            const handleBackdropClick = (e) => {
                if (e.target === e.currentTarget) {
                    onClose();
                }
            };

            const getCategoryDisplayName = (cat) => {
                if (cat.id === 'custom') return customCategoryName;
                return categoryCustomizations[cat.id]?.name || cat.name;
            };

            const getCategoryDisplayIcon = (cat) => {
                if (cat.id === 'custom') return customCategoryIcon;
                return categoryCustomizations[cat.id]?.icon || cat.icon;
            };

            const displayName = getCategoryDisplayName(category);
            const displayIcon = getCategoryDisplayIcon(category);

            return (
                <div 
                    className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"
                    onClick={handleBackdropClick}
                >
                    <div className="glass-effect rounded-2xl p-8 max-w-3xl w-full max-h-[80vh] overflow-y-auto">
                        <div className="flex items-center justify-between mb-6">
                            <div className="flex items-center space-x-3">
                                <div className="text-4xl">{displayIcon}</div>
                                <h2 className="text-3xl font-bold text-gray-800">{displayName}</h2>
                            </div>
                            <div className="flex items-center space-x-3">
                                <button
                                    onClick={handleAddService}
                                    className="bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all font-semibold text-sm"
                                >
                                    + Add Service
                                </button>
                                <button 
                                    onClick={onClose} 
                                    className="text-gray-600 hover:text-gray-800 text-3xl leading-none"
                                >
                                    √ó
                                </button>
                            </div>
                        </div>
                        
                        {services.length === 0 ? (
                            <div className="text-center py-16 text-gray-500">
                                <div className="text-6xl mb-4">{category.icon}</div>
                                <p className="text-lg">No services in this category yet.</p>
                                <button
                                    onClick={handleAddService}
                                    className="mt-4 bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-6 py-3 rounded-xl hover:shadow-lg transition-all font-semibold"
                                >
                                    + Add Your First Service
                                </button>
                            </div>
                        ) : (
                            <div className="space-y-3">
                                {services.map(service => (
                                    <div
                                        key={service.id}
                                        className={`service-item p-5 rounded-xl border-2 border-gray-200 hover:border-indigo-400 ${
                                            service.isPaused ? 'opacity-50 bg-gray-100' : ''
                                        }`}
                                    >
                                        <div className="flex justify-between items-center">
                                            <div 
                                                className="flex-1 cursor-pointer"
                                                onClick={() => onServiceClick(service)}
                                            >
                                                <div className="font-semibold text-gray-800 text-lg flex items-center gap-2">
                                                    {service.provider}
                                                    {service.isPaused && (
                                                        <span className="text-xs bg-gray-600 text-white px-2 py-1 rounded-full">‚è∏ Paused</span>
                                                    )}
                                                </div>
                                                <div className="text-sm text-gray-600 mt-1">{service.notes || 'No notes'}</div>
                                                {service.renewalDate && (
                                                    <div className="text-xs text-gray-500 mt-1">
                                                        Renews: {new Date(service.renewalDate).toLocaleDateString()}
                                                    </div>
                                                )}
                                            </div>
                                            <div className="flex items-center gap-3 ml-4">
                                                <div className="text-right">
                                                    <div className="font-bold text-indigo-600 text-xl">${service.cost}</div>
                                                    <div className="text-sm text-gray-600">{service.billingCycle}</div>
                                                </div>
                                                <button
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        if (confirm(`Delete ${service.provider}?`)) {
                                                            onDelete(service.id);
                                                        }
                                                    }}
                                                    className="text-red-600 hover:text-red-800 text-2xl p-2"
                                                    title="Delete service"
                                                >
                                                    üóëÔ∏è
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        function ServiceDetailModal({ service, onClose, onEdit, onDelete, onTogglePause, categories, customCategoryName, customCategoryIcon, categoryCustomizations }) {
            const handleBackdropClick = (e) => {
                if (e.target === e.currentTarget) {
                    onClose();
                }
            };

            const getCategoryDisplayName = (cat) => {
                if (!cat) return '';
                if (cat.id === 'custom') return customCategoryName;
                return categoryCustomizations[cat.id]?.name || cat.name;
            };

            const category = categories.find(c => c.id === service.category);

            return (
                <div 
                    className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[60]"
                    onClick={handleBackdropClick}
                >
                    <div className="glass-effect rounded-2xl p-8 max-w-3xl w-full max-h-[85vh] overflow-y-auto">
                        <div className="flex items-center justify-between mb-6">
                            <button
                                onClick={onClose}
                                className="text-gray-600 hover:text-gray-800 font-semibold"
                            >
                                ‚Üê Back
                            </button>
                            <div className="flex space-x-3">
                                <button
                                    onClick={() => onTogglePause(service.id)}
                                    className={`${
                                        service.isPaused 
                                            ? 'bg-green-600 hover:bg-green-700' 
                                            : 'bg-yellow-600 hover:bg-yellow-700'
                                    } text-white px-4 py-2 rounded-lg transition-all font-semibold`}
                                >
                                    {service.isPaused ? '‚ñ∂Ô∏è Resume' : '‚è∏ Pause'}
                                </button>
                                <button
                                    onClick={onEdit}
                                    className="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-all font-semibold"
                                >
                                    Edit
                                </button>
                                <button
                                    onClick={() => {
                                        if (confirm('Are you sure you want to delete this service?')) {
                                            onDelete(service.id);
                                        }
                                    }}
                                    className="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-all font-semibold"
                                >
                                    Delete
                                </button>
                            </div>
                        </div>
                        
                        <div className="space-y-4">
                            <div>
                                <h2 className="text-3xl font-bold text-gray-800 mb-2">{service.provider}</h2>
                                <div className="text-gray-600 text-lg">
                                    {getCategoryDisplayName(category)}
                                </div>
                            </div>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
                                <DetailField label="Cost" value={`$${service.cost}`} />
                                <DetailField label="Billing Cycle" value={service.billingCycle} />
                                <DetailField label="Start Date" value={service.startDate || 'Not set'} />
                                <DetailField label="Renewal Date" value={service.renewalDate || 'Not set'} />
                                {service.accountNumber && (
                                    <DetailField label="Account Number" value={service.accountNumber} />
                                )}
                                {service.username && (
                                    <DetailField label="Username" value={service.username} />
                                )}
                                {service.password && (
                                    <DetailField label="Password" value={service.password} />
                                )}
                                {service.phone && (
                                    <DetailField label="Phone" value={service.phone} />
                                )}
                            </div>
                            
                            {/* Vehicle-specific details */}
                            {service.category === 'vehicles' && (service.vehicleMake || service.vehicleModel || service.vehicleBodyType || service.vehicleYear) && (
                                <div className="border-t border-gray-200 pt-4 mt-6">
                                    <div className="text-sm font-semibold text-gray-700 mb-3">üöó Vehicle Details</div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        {service.vehicleMake && (
                                            <DetailField label="Make" value={service.vehicleMake} />
                                        )}
                                        {service.vehicleModel && (
                                            <DetailField label="Model" value={service.vehicleModel} />
                                        )}
                                        {service.vehicleBodyType && (
                                            <DetailField label="Body Type" value={service.vehicleBodyType} />
                                        )}
                                        {service.vehicleYear && (
                                            <DetailField label="Year" value={service.vehicleYear} />
                                        )}
                                    </div>
                                </div>
                            )}
                            
                            {service.notes && (
                                <div className="mt-6">
                                    <div className="text-sm font-semibold text-gray-700 mb-2">Notes</div>
                                    <div className="bg-gray-50 p-4 rounded-lg text-gray-700">
                                        {service.notes}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // Simple Auth Modal Component
        function AuthModal({ onClose }) {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isSignUp, setIsSignUp] = useState(false);
            const [loading, setLoading] = useState(false);
            const [message, setMessage] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setMessage('');

                try {
                    if (isSignUp) {
                        const { error } = await supabase.auth.signUp({ email, password });
                        if (error) throw error;
                        setMessage('‚úÖ Check your email to confirm your account!');
                        setTimeout(() => onClose(), 3000);
                    } else {
                        const { error } = await supabase.auth.signInWithPassword({ email, password });
                        if (error) throw error;
                        onClose();
                    }
                } catch (error) {
                    setMessage('‚ùå ' + error.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div 
                    className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"
                    onClick={(e) => e.target === e.currentTarget && onClose()}
                >
                    <div className="glass-effect rounded-2xl p-8 max-w-md w-full">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-gray-800">
                                {isSignUp ? 'Create Account' : 'Sign In'}
                            </h2>
                            <button onClick={onClose} className="text-gray-600 hover:text-gray-800 text-2xl">√ó</button>
                        </div>

                        {message && (
                            <div className="mb-4 p-3 rounded-lg bg-blue-50 text-sm">
                                {message}
                            </div>
                        )}

                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-2">Email</label>
                                <input
                                    type="email"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    className="w-full p-3 border border-gray-300 rounded-lg"
                                    required
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-2">Password</label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="w-full p-3 border border-gray-300 rounded-lg"
                                    required
                                    minLength={6}
                                />
                            </div>
                            <button
                                type="submit"
                                disabled={loading}
                                className="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-3 rounded-xl font-semibold disabled:opacity-50"
                            >
                                {loading ? 'Loading...' : (isSignUp ? 'Create Account' : 'Sign In')}
                            </button>
                        </form>

                        <button
                            onClick={() => setIsSignUp(!isSignUp)}
                            className="w-full mt-4 text-indigo-600 hover:text-indigo-700 font-semibold"
                        >
                            {isSignUp ? 'Already have an account? Sign in' : "Don't have an account? Sign up"}
                        </button>
                    </div>
                </div>
            );
        }

        function AddVehicleModal({ onClose, onAdd }) {
            const [make, setMake] = useState('');
            const [model, setModel] = useState('');
            const [year, setYear] = useState('');
            const [nickname, setNickname] = useState('');
            const [color, setColor] = useState('');
            const [licensePlate, setLicensePlate] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                
                if (!make || !model) {
                    alert('Please enter at least make and model');
                    return;
                }

                onAdd({
                    make,
                    model,
                    year: year ? parseInt(year) : null,
                    nickname,
                    color,
                    licensePlate
                });

                onClose();
            };

            const handleBackdropClick = (e) => {
                if (e.target === e.currentTarget) {
                    onClose();
                }
            };

            return (
                <div 
                    className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"
                    onClick={handleBackdropClick}
                >
                    <div className="glass-effect rounded-2xl p-8 max-w-2xl w-full max-h-[85vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-gray-800">üöó Add Vehicle</h2>
                            <button onClick={onClose} className="text-gray-600 hover:text-gray-800 text-3xl">√ó</button>
                        </div>

                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">Make *</label>
                                    <input
                                        type="text"
                                        value={make}
                                        onChange={(e) => setMake(e.target.value)}
                                        placeholder="Honda, Toyota, Tesla..."
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                        required
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">Model *</label>
                                    <input
                                        type="text"
                                        value={model}
                                        onChange={(e) => setModel(e.target.value)}
                                        placeholder="Civic, Camry, Model 3..."
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                        required
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">Year</label>
                                    <input
                                        type="number"
                                        value={year}
                                        onChange={(e) => setYear(e.target.value)}
                                        placeholder="2020"
                                        min="1900"
                                        max={new Date().getFullYear() + 1}
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">Color</label>
                                    <input
                                        type="text"
                                        value={color}
                                        onChange={(e) => setColor(e.target.value)}
                                        placeholder="Red, Blue, Black..."
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">Nickname</label>
                                    <input
                                        type="text"
                                        value={nickname}
                                        onChange={(e) => setNickname(e.target.value)}
                                        placeholder="My Car, Work Truck..."
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">License Plate</label>
                                    <input
                                        type="text"
                                        value={licensePlate}
                                        onChange={(e) => setLicensePlate(e.target.value)}
                                        placeholder="ABC123"
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    />
                                </div>
                            </div>

                            <div className="flex gap-3 pt-4">
                                <button
                                    type="submit"
                                    className="flex-1 bg-blue-600 text-white py-3 rounded-xl hover:bg-blue-700 transition-all font-semibold"
                                >
                                    Add Vehicle
                                </button>
                                <button
                                    type="button"
                                    onClick={onClose}
                                    className="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl hover:bg-gray-300 transition-all font-semibold"
                                >
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function VehicleModal({ vehicle, services, onClose, onAddService, categories, customCategoryName, customCategoryIcon, categoryCustomizations }) {
            const handleBackdropClick = (e) => {
                if (e.target === e.currentTarget) {
                    onClose();
                }
            };

            const getCategoryDisplayName = (cat) => {
                if (!cat) return '';
                if (cat.id === 'custom') return customCategoryName;
                return categoryCustomizations[cat.id]?.name || cat.name;
            };

            const getCategoryDisplayIcon = (cat) => {
                if (!cat) return '';
                if (cat.id === 'custom') return customCategoryIcon;
                return categoryCustomizations[cat.id]?.icon || cat.icon;
            };

            const monthlyCost = services.reduce((total, service) => {
                if (service.isPaused || service.billingCycle === 'one-time') return total;
                
                let cost = 0;
                if (service.billingCycle === 'weekly') cost = service.cost * 4.33;
                else if (service.billingCycle === 'monthly') cost = service.cost;
                else if (service.billingCycle === 'yearly') cost = service.cost / 12;
                
                return total + cost;
            }, 0);

            return (
                <div 
                    className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"
                    onClick={handleBackdropClick}
                >
                    <div className="glass-effect rounded-2xl p-8 max-w-3xl w-full max-h-[85vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-6">
                            <div>
                                <h2 className="text-3xl font-bold text-gray-800 mb-1">
                                    üöó {vehicle.nickname || `${vehicle.make} ${vehicle.model}`}
                                </h2>
                                <p className="text-gray-600">
                                    {vehicle.year} {vehicle.color && `‚Ä¢ ${vehicle.color}`}
                                    {vehicle.licensePlate && ` ‚Ä¢ ${vehicle.licensePlate}`}
                                </p>
                            </div>
                            <button onClick={onClose} className="text-gray-600 hover:text-gray-800 text-3xl">√ó</button>
                        </div>

                        <div className="bg-blue-50 rounded-xl p-4 mb-6">
                            <div className="text-3xl font-bold text-blue-600">
                                ${monthlyCost.toFixed(2)}
                                <span className="text-lg text-gray-600 font-normal">/month</span>
                            </div>
                            <div className="text-sm text-gray-600 mt-1">
                                Total monthly cost for this vehicle
                            </div>
                        </div>

                        <div className="mb-4 flex justify-between items-center">
                            <h3 className="text-xl font-bold text-gray-800">Services ({services.length})</h3>
                            <button
                                onClick={() => {
                                    onAddService(vehicle.id);
                                    onClose();
                                }}
                                className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-all font-semibold text-sm"
                            >
                                + Add Service
                            </button>
                        </div>

                        {services.length === 0 ? (
                            <div className="text-center py-12 text-gray-500">
                                <div className="text-5xl mb-4">üìã</div>
                                <p>No services for this vehicle yet.</p>
                                <p className="text-sm mt-2">Add insurance, registration, fuel, and more!</p>
                            </div>
                        ) : (
                            <div className="space-y-3">
                                {services.map(service => {
                                    const category = categories.find(c => c.id === service.category);
                                    return (
                                        <div
                                            key={service.id}
                                            className="p-4 bg-white rounded-xl border-2 border-gray-200 hover:border-blue-300 transition-all"
                                        >
                                            <div className="flex justify-between items-center">
                                                <div className="flex items-center space-x-4">
                                                    <div className="text-3xl">{getCategoryDisplayIcon(category)}</div>
                                                    <div>
                                                        <div className="font-semibold text-gray-800 flex items-center gap-2">
                                                            {service.provider}
                                                            {service.isPaused && (
                                                                <span className="text-xs bg-gray-600 text-white px-2 py-1 rounded-full">‚è∏ Paused</span>
                                                            )}
                                                        </div>
                                                        <div className="text-sm text-gray-600">{getCategoryDisplayName(category)}</div>
                                                    </div>
                                                </div>
                                                <div className="text-right">
                                                    <div className="font-bold text-gray-800">${service.cost}</div>
                                                    <div className="text-sm text-gray-600">{service.billingCycle}</div>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        function NotificationSettingsModal({ preferences, upcomingRenewals, onClose, onSave, categories, customCategoryName, customCategoryIcon, categoryCustomizations }) {
            const [enabled, setEnabled] = useState(preferences.enabled);
            const [daysBeforeRenewal, setDaysBeforeRenewal] = useState(preferences.daysBeforeRenewal);
            const [emailNotifications, setEmailNotifications] = useState(preferences.emailNotifications);

            const handleBackdropClick = (e) => {
                if (e.target === e.currentTarget) {
                    onClose();
                }
            };

            const handleSave = () => {
                onSave({
                    enabled,
                    daysBeforeRenewal: parseInt(daysBeforeRenewal),
                    emailNotifications
                });
            };

            const getDaysUntilRenewal = (renewalDate) => {
                const today = new Date();
                const renewal = new Date(renewalDate);
                return Math.ceil((renewal - today) / (1000 * 60 * 60 * 24));
            };

            const getCategoryDisplayIcon = (cat) => {
                if (cat?.id === 'custom') return customCategoryIcon;
                return categoryCustomizations[cat?.id]?.icon || cat?.icon;
            };

            return (
                <div 
                    className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[70]"
                    onClick={handleBackdropClick}
                >
                    <div className="glass-effect rounded-2xl p-8 max-w-2xl w-full max-h-[85vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-gray-800">üîî Notification Settings</h2>
                            <button onClick={onClose} className="text-gray-600 hover:text-gray-800 text-3xl">√ó</button>
                        </div>

                        <div className="space-y-6">
                            {/* Enable Notifications Toggle */}
                            <div className="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                <div>
                                    <div className="font-semibold text-gray-800">Enable Notifications</div>
                                    <div className="text-sm text-gray-600">Get reminded about upcoming renewals</div>
                                </div>
                                <label className="relative inline-flex items-center cursor-pointer">
                                    <input 
                                        type="checkbox" 
                                        checked={enabled}
                                        onChange={(e) => setEnabled(e.target.checked)}
                                        className="sr-only peer"
                                    />
                                    <div className="w-11 h-6 bg-gray-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                                </label>
                            </div>

                            {/* Days Before Renewal */}
                            {enabled && (
                                <div className="p-4 bg-gray-50 rounded-lg">
                                    <label className="block font-semibold text-gray-800 mb-2">
                                        Notify me this many days before renewal:
                                    </label>
                                    <select
                                        value={daysBeforeRenewal}
                                        onChange={(e) => setDaysBeforeRenewal(e.target.value)}
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                    >
                                        <option value="1">1 day</option>
                                        <option value="3">3 days</option>
                                        <option value="7">7 days (1 week)</option>
                                        <option value="14">14 days (2 weeks)</option>
                                        <option value="30">30 days (1 month)</option>
                                    </select>
                                </div>
                            )}

                            {/* Email Notifications */}
                            {enabled && (
                                <div className="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                    <div>
                                        <div className="font-semibold text-gray-800">Email Notifications</div>
                                        <div className="text-sm text-gray-600">Receive renewal reminders via email</div>
                                        <div className="text-xs text-yellow-600 mt-1">‚ö†Ô∏è Coming soon - requires setup</div>
                                    </div>
                                    <label className="relative inline-flex items-center cursor-pointer">
                                        <input 
                                            type="checkbox" 
                                            checked={emailNotifications}
                                            onChange={(e) => setEmailNotifications(e.target.checked)}
                                            disabled
                                            className="sr-only peer"
                                        />
                                        <div className="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-purple-600 cursor-not-allowed opacity-50"></div>
                                    </label>
                                </div>
                            )}

                            {/* Upcoming Renewals */}
                            {enabled && upcomingRenewals.length > 0 && (
                                <div className="border-t border-gray-200 pt-6">
                                    <h3 className="font-bold text-lg text-gray-800 mb-4">
                                        üìÖ Upcoming Renewals ({upcomingRenewals.length})
                                    </h3>
                                    <div className="space-y-3">
                                        {upcomingRenewals.map(service => {
                                            const category = categories.find(c => c.id === service.category);
                                            const displayIcon = getCategoryDisplayIcon(category);
                                            const daysLeft = getDaysUntilRenewal(service.renewalDate);
                                            return (
                                                <div key={service.id} className="p-4 bg-yellow-50 border-l-4 border-yellow-500 rounded-lg">
                                                    <div className="flex items-center justify-between">
                                                        <div className="flex items-center gap-3">
                                                            <span className="text-2xl">{displayIcon}</span>
                                                            <div>
                                                                <div className="font-semibold text-gray-800">{service.provider}</div>
                                                                <div className="text-sm text-gray-600">
                                                                    Renews in {daysLeft} day{daysLeft !== 1 ? 's' : ''} ‚Ä¢ {new Date(service.renewalDate).toLocaleDateString()}
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div className="text-right">
                                                            <div className="font-bold text-gray-800">${service.cost}</div>
                                                            <div className="text-sm text-gray-600">{service.billingCycle}</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            )}

                            {enabled && upcomingRenewals.length === 0 && (
                                <div className="text-center py-8 text-gray-500">
                                    <div className="text-5xl mb-3">‚úÖ</div>
                                    <p>No upcoming renewals in the next {daysBeforeRenewal} days</p>
                                </div>
                            )}
                        </div>

                        <div className="flex gap-3 mt-6">
                            <button
                                onClick={handleSave}
                                className="flex-1 bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-3 rounded-xl hover:shadow-lg transition-all font-semibold"
                            >
                                Save Settings
                            </button>
                            <button
                                onClick={onClose}
                                className="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl hover:bg-gray-300 transition-all font-semibold"
                            >
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            );
        }
        
        function ImportCSVModal({ detectedSubscriptions, selectedImports, onClose, onUpload, onToggleSelect, onImport }) {
            const [currentIndex, setCurrentIndex] = React.useState(0);
            const [reviewMode, setReviewMode] = React.useState(false);
            const [editedService, setEditedService] = React.useState(null);
            const [showOptionalFields, setShowOptionalFields] = React.useState(false);
            
            const startReview = () => {
                if (detectedSubscriptions.length > 0) {
                    setCurrentIndex(0);
                    setReviewMode(true);
                    const firstSub = detectedSubscriptions[0];
                    setEditedService({
                        name: firstSub.payee,
                        cost: firstSub.amount.toFixed(2),
                        frequency: firstSub.frequency,
                        category: 'subscriptions',
                        renewalDate: '',
                        accountNumber: '',
                        username: '',
                        password: '',
                        phone: '',
                        notes: `Auto-imported from bank statement. ${firstSub.occurrences} payments detected.`
                    });
                }
            };
            
            const handleNext = (skip = false) => {
                if (!skip && editedService) {
                    // Add the service
                    const newService = {
                        id: Date.now() + Math.random(),
                        ...editedService,
                        isPaused: false
                    };
                    onImport([newService]);
                }
                
                // Move to next
                if (currentIndex < detectedSubscriptions.length - 1) {
                    const nextIndex = currentIndex + 1;
                    setCurrentIndex(nextIndex);
                    const nextSub = detectedSubscriptions[nextIndex];
                    setEditedService({
                        name: nextSub.payee,
                        cost: nextSub.amount.toFixed(2),
                        frequency: nextSub.frequency,
                        category: 'subscriptions',
                        renewalDate: '',
                        accountNumber: '',
                        username: '',
                        password: '',
                        phone: '',
                        notes: `Auto-imported from bank statement. ${nextSub.occurrences} payments detected.`
                    });
                    setShowOptionalFields(false);
                } else {
                    // Finished
                    onClose();
                }
            };
            
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-3xl p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-3xl font-bold text-gray-800">Import Bank Statement</h2>
                            <button 
                                onClick={onClose}
                                className="text-gray-500 hover:text-gray-700 text-2xl"
                            >
                                √ó
                            </button>
                        </div>
                        
                        {!reviewMode ? (
                            // Upload screen
                            detectedSubscriptions.length === 0 ? (
                                <div className="text-center py-12">
                                    <div className="text-6xl mb-4">üìä</div>
                                    <h3 className="text-xl font-semibold mb-4">Upload Your Bank Statement</h3>
                                    <p className="text-gray-600 mb-6">
                                        Upload a CSV file from your bank and we'll automatically detect recurring payments
                                    </p>
                                    <div className="mb-4">
                                        <label className="inline-block cursor-pointer bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-8 py-3 rounded-xl hover:shadow-lg transition-all font-semibold">
                                            Choose CSV File
                                            <input 
                                                type="file" 
                                                accept=".csv" 
                                                onChange={onUpload}
                                                className="hidden"
                                            />
                                        </label>
                                    </div>
                                    <p className="text-sm text-gray-500">
                                        Supported: Westpac, CommBank, NAB, ANZ (CSV format)
                                    </p>
                                </div>
                            ) : (
                                <div>
                                    <div className="mb-6 p-4 bg-green-50 rounded-xl border-2 border-green-200 text-center">
                                        <p className="text-green-800 font-semibold text-lg">
                                            ‚úì Found {detectedSubscriptions.length} recurring payments
                                        </p>
                                        <p className="text-sm text-green-600 mt-1">
                                            Review each one and assign to categories
                                        </p>
                                    </div>
                                    
                                    <button
                                        onClick={startReview}
                                        className="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-4 rounded-xl hover:shadow-lg transition-all font-semibold text-lg"
                                    >
                                        Start Reviewing ‚Üí
                                    </button>
                                </div>
                            )
                        ) : (
                            // Review screen
                            <div>
                                <div className="mb-6 p-3 bg-purple-50 rounded-xl border-2 border-purple-200 text-center">
                                    <p className="text-purple-800 font-semibold">
                                        Service {currentIndex + 1} of {detectedSubscriptions.length}
                                    </p>
                                </div>
                                
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-semibold text-gray-700 mb-2">Service Name *</label>
                                        <input
                                            type="text"
                                            value={editedService.name}
                                            onChange={(e) => setEditedService({...editedService, name: e.target.value})}
                                            className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none"
                                        />
                                    </div>
                                    
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-semibold text-gray-700 mb-2">Cost ($) *</label>
                                            <input
                                                type="number"
                                                step="0.01"
                                                value={editedService.cost}
                                                onChange={(e) => setEditedService({...editedService, cost: e.target.value})}
                                                className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-semibold text-gray-700 mb-2">Frequency *</label>
                                            <select
                                                value={editedService.frequency}
                                                onChange={(e) => setEditedService({...editedService, frequency: e.target.value})}
                                                className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none"
                                            >
                                                <option value="Weekly">Weekly</option>
                                                <option value="Fortnightly">Fortnightly</option>
                                                <option value="Monthly">Monthly</option>
                                                <option value="Quarterly">Quarterly</option>
                                                <option value="Yearly">Yearly</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-semibold text-gray-700 mb-2">Category *</label>
                                        <select
                                            value={editedService.category}
                                            onChange={(e) => setEditedService({...editedService, category: e.target.value})}
                                            className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none"
                                        >
                                            <option value="internet">Internet & TV</option>
                                            <option value="utilities">Utilities</option>
                                            <option value="subscriptions">Subscriptions</option>
                                            <option value="insurance">Insurance</option>
                                            <option value="financial">Financial</option>
                                            <option value="home">Home Services</option>
                                            <option value="vehicles">Vehicles</option>
                                            <option value="memberships">Memberships</option>
                                            <option value="custom">Custom</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-semibold text-gray-700 mb-2">Renewal Date</label>
                                        <input
                                            type="date"
                                            value={editedService.renewalDate}
                                            onChange={(e) => setEditedService({...editedService, renewalDate: e.target.value})}
                                            className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none"
                                        />
                                    </div>
                                    
                                    {/* Optional Fields */}
                                    <div>
                                        <button
                                            onClick={() => setShowOptionalFields(!showOptionalFields)}
                                            className="w-full flex items-center justify-between px-4 py-3 bg-gray-50 rounded-xl hover:bg-gray-100 transition-all"
                                        >
                                            <span className="text-sm font-semibold text-gray-700">Optional Fields</span>
                                            <span className="text-gray-500">{showOptionalFields ? '‚ñ≤' : '‚ñº'}</span>
                                        </button>
                                        
                                        {showOptionalFields && (
                                            <div className="mt-4 space-y-4 p-4 bg-gray-50 rounded-xl">
                                                <div>
                                                    <label className="block text-sm font-semibold text-gray-700 mb-2">Account Number</label>
                                                    <input
                                                        type="text"
                                                        value={editedService.accountNumber}
                                                        onChange={(e) => setEditedService({...editedService, accountNumber: e.target.value})}
                                                        className="w-full px-4 py-2 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-semibold text-gray-700 mb-2">Username</label>
                                                    <input
                                                        type="text"
                                                        value={editedService.username}
                                                        onChange={(e) => setEditedService({...editedService, username: e.target.value})}
                                                        className="w-full px-4 py-2 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-semibold text-gray-700 mb-2">Password</label>
                                                    <input
                                                        type="password"
                                                        value={editedService.password}
                                                        onChange={(e) => setEditedService({...editedService, password: e.target.value})}
                                                        className="w-full px-4 py-2 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-semibold text-gray-700 mb-2">Phone</label>
                                                    <input
                                                        type="tel"
                                                        value={editedService.phone}
                                                        onChange={(e) => setEditedService({...editedService, phone: e.target.value})}
                                                        className="w-full px-4 py-2 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-semibold text-gray-700 mb-2">Notes</label>
                                                    <textarea
                                                        value={editedService.notes}
                                                        onChange={(e) => setEditedService({...editedService, notes: e.target.value})}
                                                        className="w-full px-4 py-2 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none"
                                                        rows="3"
                                                    />
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                                
                                <div className="flex gap-3 mt-6">
                                    <button
                                        onClick={() => handleNext(false)}
                                        className="flex-1 bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-3 rounded-xl hover:shadow-lg transition-all font-semibold"
                                    >
                                        {currentIndex < detectedSubscriptions.length - 1 ? 'Add & Next ‚Üí' : 'Add & Finish'}
                                    </button>
                                    <button
                                        onClick={() => handleNext(true)}
                                        className="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl hover:bg-gray-300 transition-all font-semibold"
                                    >
                                        Skip
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<BilliApp />, document.getElementById('root'));
    </script>
</body>
</html>
